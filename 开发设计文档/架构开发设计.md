# IM 微服务架构与开发设计文档
技术栈：JDK 17、Spring Boot 3、Spring WebFlux、MyBatis-Plus、Redis、MySQL 8、MinIO、NATS、Maven  
部署形态：三个核心微服务（前端业务服务、通信服务、后台管理服务）+ 公共模块，基于NATS事件总线通信  
目标规模：总用户 50,000，日活 10,000；群组上限 5,000，活跃同时 2,000；端到端 P95 < 200ms（同城）

---

## 1. 总览与目标

### 1.1 功能目标（IM 核心）
- 单聊/群聊、文本/富文本/图片与文件
- 历史消息与搜索、会话管理（置顶/免打扰/已读回执）
- 群组管理（创建/邀请/踢人/禁言/公告/角色）
- 在线状态与多端设备管理
- 推送与离线补偿、消息撤回、编辑
- 管理后台（用户/群组/风控/审计）

### 1.2 非功能目标
- 微服务架构：三个核心服务独立部署，通过NATS事件总线通信
- 可水平扩展：每个服务可独立扩展，支持多实例部署
- 一致性：同会话内强顺序；幂等插入；至少一次下发+客户端补偿
- 安全：鉴权、权限、限流、审计
- 可观测：指标、日志、追踪
- 响应式架构：基于WebFlux的非阻塞异步处理

---

## 2. 架构设计

### 2.1 整体架构概览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            IM 三服务架构（基于NATS）                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                             前端业务服务                                    │ │
│  │                           (Business Service)                               │ │
│  │                                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │   用户管理   │  │   社交管理   │  │   内容管理   │  │      搜索服务       │ │ │
│  │  │             │  │             │  │             │  │                     │ │ │
│  │  │ • 用户注册   │  │ • 好友关系   │  │ • 文件管理   │  │ • 全文搜索         │ │ │
│  │  │ • 个人资料   │  │ • 会话管理   │  │ • 图片处理   │  │ • 历史搜索         │ │ │
│  │  │ • 设备管理   │  │ • 群组管理   │  │ • 收藏管理   │  │ • 智能推荐         │ │ │
│  │  │ • 在线状态   │  │ • 群成员     │  │ • 内容审核   │  │ • 搜索统计         │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                             │
│                                    ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                             通信服务                                        │ │
│  │                           (Communication Service)                          │ │
│  │                                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │  消息处理    │  │  实时通信    │  │  消息路由    │  │      推送服务       │ │ │
│  │  │             │  │             │  │             │  │                     │ │ │
│  │  │ • 消息存储   │  │ • WebSocket │  │ • 消息分发   │  │ • 离线推送         │ │ │
│  │  │ • 消息历史   │  │ • 长连接管理 │  │ • 跨服务路由 │  │ • 通知推送         │ │ │
│  │  │ • 消息序列   │  │ • 心跳管理   │  │ • 负载均衡   │  │ • 消息确认         │ │ │
│  │  │ • 幂等处理   │  │ • 连接池     │  │ • 故障转移   │  │ • 重试机制         │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                             │
│                                    ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                             后台管理服务                                    │ │
│  │                           (Admin Service)                                  │ │
│  │                                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │   系统监控   │  │   运维管理   │  │   配置管理   │  │      安全审计       │ │ │
│  │  │             │  │             │  │             │  │                     │ │ │
│  │  │ • 性能监控   │  │ • 部署管理   │  │ • 系统配置   │  │ • 内容审核         │ │ │
│  │  │ • 资源监控   │  │ • 维护管理   │  │ • 功能开关   │  │ • 敏感词检测       │ │ │
│  │  │ • 业务监控   │  │ • 备份恢复   │  │ • 参数配置   │  │ • 风险评估         │ │ │
│  │  │ • 告警管理   │  │ • 日志管理   │  │ • 策略管理   │  │ • 审计日志         │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                             公共模块                                            │
│                           (Common Modules)                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │   基础设施       │    │   工具组件       │    │      安全组件               │ │
│  │                 │    │                 │    │                             │ │
│  │ • 数据库访问     │    │ • 缓存管理       │    │ • JWT认证                   │ │
│  │ • Redis客户端    │    │ • 消息队列       │    │ • 权限控制                   │ │
│  │ • MinIO客户端    │    │ • 日志组件       │    │ • 加密解密                   │ │
│  │ • NATS客户端     │    │ • 监控组件       │    │ • 限流组件                   │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 服务职责与边界

#### 2.2.1 前端业务服务 (Business Service)
- **职责**：处理所有业务逻辑，提供REST API
- **技术栈**：Spring Boot 3 + MyBatis-Plus + Redis
- **数据存储**：MySQL（业务数据）+ Redis（缓存）
- **主要功能**：
  - 用户管理：注册、登录、个人资料、设备管理
  - 社交管理：好友关系、会话管理、群组管理
  - 内容管理：文件管理、收藏管理、内容审核
  - 搜索服务：全文搜索、历史搜索、智能推荐
- **推送触发**：通过NATS事件触发推送，不直接处理WebSocket

#### 2.2.2 通信服务 (Communication Service)
- **职责**：处理实时通信、消息路由、推送
- **技术栈**：Spring WebFlux + Netty + Redis
- **数据存储**：MySQL（消息数据）+ Redis（连接管理、消息缓存）
- **主要功能**：
  - 消息处理：消息存储、消息历史、消息序列、幂等处理
  - 实时通信：WebSocket管理、连接管理、心跳管理
  - 消息路由：消息分发、负载均衡、故障转移
  - 推送服务：离线推送、通知推送、消息确认
- **WebSocket实现**：负责WebSocket具体实现和推送逻辑

#### 2.2.3 后台管理服务 (Admin Service)
- **职责**：系统监控、运维管理、配置管理、安全审计
- **技术栈**：Spring Boot 3 + 监控组件 + 配置中心
- **数据存储**：MySQL（管理数据）+ Redis（监控数据）+ 时序数据库
- **主要功能**：
  - 系统监控：性能监控、资源监控、业务监控、告警管理
  - 运维管理：部署管理、维护管理、备份恢复、日志管理
  - 配置管理：系统配置、功能开关、参数配置、策略管理
  - 安全审计：内容审核、敏感词检测、风险评估、审计日志
- **推送需求**：推送需求较少，通过NATS事件触发

### 2.3 数据流向图

```
客户端请求流程:
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 客户端  │───▶│  负载均衡器  │───▶│ 前端业务    │───▶│  通信服务   │───▶│ 客户端  │
│         │    │             │    │  服务       │    │             │    │         │
└─────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────┘
                       │                    │                    │
                       ▼                    ▼                    ▼
                ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
                │  认证授权   │    │  业务处理   │    │  实时推送   │
                │  (JWT)     │    │  (业务逻辑) │    │ (WebSocket) │
                └─────────────┘    └─────────────┘    └─────────────┘

消息发送流程:
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 客户端  │───▶│  通信服务   │───▶│  消息处理   │───▶│  消息路由   │───▶│ 目标客户端│
│         │    │             │    │             │    │             │    │         │
└─────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────┘
                       │                    │                    │
                       ▼                    ▼                    ▼
                ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
                │  消息验证   │    │  消息存储   │    │  NATS事件   │
                │  (权限检查) │    │  (MySQL)    │    │ (消息广播)  │
                └─────────────┘    └─────────────┘    └─────────────┘
                       │                    │                    │
                       ▼                    ▼                    ▼
                ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
                │  内容审核   │    │  消息分发   │    │  推送确认   │
                │ (安全服务)  │    │ (目标计算)  │    │ (状态更新)  │
                └─────────────┘    └─────────────┘    └─────────────┘
```

### 2.4 服务间通信架构

#### 2.4.1 WebSocket推送架构设计
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              WebSocket推送架构                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │   业务服务      │    │   管理服务      │    │      通信服务               │ │ │
│  │                 │    │                 │    │                             │ │ │
│  │ • 用户操作      │    │ • 系统告警      │    │ • WebSocket连接管理         │ │ │
│  │ • 消息发送      │    │ • 配置变更      │    │ • 消息推送逻辑              │ │ │
│  │ • 状态变更      │    │ • 监控数据      │    │ • 连接池管理               │ │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │ │
│           │                       │                       │                     │
│           ▼                       ▼                       ▼                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                              NATS事件总线                                  │ │
│  │                                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │  推送事件   │  │  状态事件   │  │  系统事件   │  │      业务事件       │ │ │
│  │  │             │  │             │  │             │  │                     │ │ │
│  │  │ • 消息推送  │  │ • 在线状态  │  │ • 系统告警  │  │ • 用户操作         │ │ │
│  │  │ • 通知推送  │  │ • 设备状态  │  │ • 配置变更  │  │ • 群组变更         │ │ │
│  │  │ • 离线推送  │  │ • 会话状态  │  │ • 监控数据  │  │ • 内容更新         │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                             │
│                                    ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                             通信服务处理                                    │ │
│  │                                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │  事件订阅   │  │  消息路由   │  │  推送逻辑   │  │    WebSocket管理    │ │ │
│  │  │             │  │             │  │             │  │                     │ │ │
│  │  │ • 事件监听  │  │ • 目标计算  │  │ • 实时推送  │  │ • 连接建立         │ │ │
│  │  │ • 事件过滤  │  │ • 负载均衡  │  │ • 离线推送  │  │ • 连接维护         │ │ │
│  │  │ • 事件重试  │  │ • 故障转移  │  │ • 批量推送  │  │ • 连接断开         │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                             │
│                                    ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                             客户端接收                                      │ │
│  │                                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │  消息处理   │  │  状态更新   │  │  界面刷新   │  │      离线存储       │ │ │
│  │  │             │  │             │  │             │  │                     │ │
│  │  │ • 消息解析  │  │ • 状态同步  │  │ • UI更新    │  │ • 本地缓存         │ │ │
│  │  │ • 消息显示  │  │ • 数据同步  │  │ • 通知显示  │  │ • 离线消息         │ │ │
│  │  │ • 消息存储  │  │ • 缓存更新  │  │ • 交互反馈  │  │ • 同步机制         │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘ │
```

#### 2.4.2 WebSocket推送职责分工

**公共模块职责**：
- **消息格式定义**：统一的WebSocket消息结构
- **事件定义**：推送相关的事件类型和DTO
- **常量定义**：消息类型、状态码、错误码等
- **NATS客户端**：事件发布和订阅的基础组件

**通信服务职责**：
- **WebSocket连接管理**：连接建立、维护、断开、心跳检测
- **消息推送逻辑**：实时推送、离线推送、批量推送、重试机制
- **连接池管理**：高性能连接管理、负载均衡
- **消息路由**：目标计算、实例选择、故障转移

**其他服务职责**：
- **业务服务**：通过NATS事件触发推送，不直接处理WebSocket
- **管理服务**：通过NATS事件触发系统通知，推送需求较少

#### 2.4.3 NATS事件总线设计
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              NATS 事件总线                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │   消息事件       │    │   状态事件       │    │      系统事件               │ │ │
│  │                 │    │                 │    │                             │ │ │
│  │ • im.message.*  │    │ • im.presence.* │    │ • im.system.*              │ │ │
│  │ • im.chat.*     │    │ • im.status.*   │    │ • im.admin.*               │ │ │
│  │ • im.history.*  │    │ • im.device.*   │    │ • im.monitoring.*          │ │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │ │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │ │
│  │   社交事件       │    │   内容事件       │    │      安全事件               │ │ │
│  │                 │    │                 │    │                             │ │ │
│  │ • im.friend.*   │    │ • im.file.*     │    │ • im.security.*            │ │ │
│  │ • im.group.*    │    │ • im.search.*   │    │ • im.audit.*               │ │ │
│  │ • im.conv.*     │    │ • im.favorite.* │    │ • im.compliance.*          │ │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │ │
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │ │
│  │   配置事件       │    │   监控事件       │    │      运维事件               │ │ │
│  │                 │    │                 │    │                             │ │ │
│  │ • im.config.*   │    │ • im.metrics.*  │    │ • im.operations.*          │ │ │
│  │ • im.feature.*  │    │ • im.alerting.* │    │ • im.deployment.*          │ │ │
│  │ • im.policy.*   │    │ • im.health.*   │    │ • im.maintenance.*         │ │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │ │
└─────────────────────────────────────────────────────────────────────────────────┘ │
```

#### 2.4.2 同步通信（HTTP/REST）
- **服务发现**：基于NATS的服务发现机制
- **负载均衡**：客户端负载均衡 + 服务端负载均衡
- **熔断降级**：基于Resilience4j的熔断器模式
- **重试机制**：指数退避重试策略

#### 2.4.3 异步通信（NATS事件）
- **事件发布**：基于NATS的发布订阅模式
- **事件存储**：JetStream持久化关键事件
- **事件重放**：支持事件重放和审计
- **死信队列**：处理失败事件的死信队列

---

## 3. 项目结构设计

### 3.1 整体项目结构

```
im-microservices/
├─ pom.xml                                    # 父POM
├─ common/                                    # 公共模块
│  ├─ pom.xml
│  ├─ src/main/java/com/acme/im/common/
│  │  ├─ infrastructure/                      # 基础设施
│  │  │  ├─ database/                         # 数据库访问
│  │  │  ├─ redis/                            # Redis客户端
│  │  │  ├─ minio/                            # MinIO客户端
│  │  │  └─ nats/                             # NATS客户端
│  │  ├─ utils/                               # 工具组件
│  │  │  ├─ cache/                            # 缓存管理
│  │  │  ├─ queue/                            # 消息队列
│  │  │  ├─ logging/                          # 日志组件
│  │  │  └─ monitoring/                       # 监控组件
│  │  └─ security/                            # 安全组件
│  │     ├─ jwt/                              # JWT认证
│  │     ├─ permission/                       # 权限控制
│  │     ├─ encryption/                       # 加密解密
│  │     └─ rateLimit/                        # 限流组件
│  └─ src/main/resources/
├─ business-service/                           # 前端业务服务
│  ├─ pom.xml
│  ├─ src/main/java/com/acme/im/business/
│  │  ├─ user/                                # 用户管理
│  │  │  ├─ controller/                       # 用户API
│  │  │  ├─ service/                          # 用户业务逻辑
│  │  │  ├─ repository/                       # 数据访问
│  │  │  └─ entity/                           # 用户实体
│  │  ├─ social/                              # 社交管理
│  │  │  ├─ friend/                           # 好友关系
│  │  │  ├─ conversation/                     # 会话管理
│  │  │  └─ group/                            # 群组管理
│  │  ├─ content/                             # 内容管理
│  │  │  ├─ file/                             # 文件管理
│  │  │  ├─ favorite/                         # 收藏管理
│  │  │  └─ audit/                            # 内容审核
│  │  └─ search/                              # 搜索服务
│  │     ├─ global/                           # 全局搜索
│  │     ├─ conversation/                     # 会话搜索
│  │     └─ file/                             # 文件搜索
│  └─ src/main/resources/
├─ communication-service/                      # 通信服务
│  ├─ pom.xml
│  ├─ src/main/java/com/acme/im/communication/
│  │  ├─ message/                             # 消息处理
│  │  │  ├─ handler/                          # 消息处理器
│  │  │  ├─ storage/                          # 消息存储
│  │  │  ├─ sequence/                         # 消息序列
│  │  │  └─ idempotent/                       # 幂等处理
│  │  ├─ realtime/                            # 实时通信
│  │  │  ├─ websocket/                        # WebSocket管理
│  │  │  ├─ connection/                       # 连接管理
│  │  │  ├─ heartbeat/                        # 心跳管理
│  │  │  └─ pool/                             # 连接池
│  │  ├─ routing/                             # 消息路由
│  │  │  ├─ dispatcher/                       # 消息分发器
│  │  │  ├─ loadbalancer/                     # 负载均衡
│  │  │  ├─ failover/                         # 故障转移
│  │  │  └─ cross_service/                    # 跨服务路由
│  │  └─ push/                                # 推送服务
│  │     ├─ offline/                          # 离线推送
│  │     ├─ notification/                     # 通知推送
│  │     ├─ confirmation/                     # 消息确认
│  │     └─ retry/                            # 重试机制
│  └─ src/main/resources/
├─ admin-service/                              # 后台管理服务
│  ├─ pom.xml
│  ├─ src/main/java/com/acme/im/admin/
│  │  ├─ monitoring/                          # 系统监控
│  │  │  ├─ system/                           # 系统监控
│  │  │  ├─ business/                         # 业务监控
│  │  │  ├─ performance/                      # 性能监控
│  │  │  └─ alerting/                         # 告警管理
│  │  ├─ operations/                          # 运维管理
│  │  │  ├─ deployment/                       # 部署管理
│  │  │  ├─ maintenance/                      # 维护管理
│  │  │  ├─ backup/                           # 备份恢复
│  │  │  └─ logs/                             # 日志管理
│  │  ├─ configuration/                       # 配置管理
│  │  │  ├─ system/                           # 系统配置
│  │  │  ├─ features/                         # 功能开关
│  │  │  ├─ parameters/                       # 参数配置
│  │  │  └─ templates/                        # 配置模板
│  │  └─ security/                            # 安全审计
│  │     ├─ content/                          # 内容审核
│  │     ├─ sensitive/                        # 敏感词检测
│  │     ├─ risk/                             # 风险评估
│  │     └─ audit/                            # 审计日志
│  └─ src/main/resources/
├─ docs/                                      # 项目文档
├─ scripts/                                   # 部署脚本
├─ docker/                                    # Docker相关文件
└─ README.md
```

### 3.2 公共模块详细结构

```
common/
├─ pom.xml
├─ src/main/java/com/acme/im/common/
│  ├─ infrastructure/                          # 基础设施
│  │  ├─ database/                             # 数据库访问
│  │  │  ├─ config/                            # 数据库配置
│  │  │  ├─ datasource/                        # 数据源管理
│  │  │  ├─ transaction/                       # 事务管理
│  │  │  └─ migration/                         # 数据库迁移
│  │  ├─ redis/                                # Redis客户端
│  │  │  ├─ config/                            # Redis配置
│  │  │  ├─ template/                          # Redis操作模板
│  │  │  ├─ lua/                               # Lua脚本
│  │  │  └─ key/                               # 键空间管理
│  │  ├─ minio/                                # MinIO客户端
│  │  │  ├─ config/                            # MinIO配置
│  │  │  ├─ client/                            # MinIO客户端
│  │  │  ├─ upload/                            # 上传处理
│  │  │  └─ download/                          # 下载处理
│  │  └─ nats/                                 # NATS客户端
│  │     ├─ config/                            # NATS配置
│  │     ├─ client/                            # NATS客户端
│  │     ├─ publisher/                         # 事件发布器
│  │     ├─ subscriber/                        # 事件订阅器
│  │     └─ jetstream/                         # JetStream持久化
│  ├─ websocket/                               # WebSocket基础组件
│  │  ├─ message/                              # 消息格式定义
│  │  │  ├─ types/                             # 消息类型枚举
│  │  │  ├─ structure/                         # 消息结构定义
│  │  │  └─ validation/                        # 消息验证规则
│  │  ├─ dto/                                  # 数据传输对象
│  │  │  ├─ request/                           # 请求对象
│  │  │  ├─ response/                          # 响应对象
│  │  │  └─ notification/                      # 通知对象
│  │  └─ constants/                            # 常量定义
│  │     ├─ messageTypes/                      # 消息类型常量
│  │     ├─ statusCodes/                       # 状态码常量
│  │     └─ errorCodes/                        # 错误码常量
│  ├─ discovery/                               # 服务发现组件
│  │  ├─ config/                               # 服务发现配置
│  │  ├─ registry/                             # 服务注册器
│  │  ├─ resolver/                             # 服务解析器
│  │  └─ health/                               # 健康检查
│  ├─ loadbalancer/                            # 负载均衡组件
│  │  ├─ strategy/                             # 负载均衡策略
│  │  │  ├─ roundRobin/                        # 轮询策略
│  │  │  ├─ leastConnections/                  # 最少连接策略
│  │  │  ├─ weighted/                          # 权重策略
│  │  │  └─ consistentHash/                    # 一致性哈希
│  │  ├─ selector/                             # 实例选择器
│  │  └─ health/                               # 健康检查
│  ├─ resilience/                              # 容错组件
│  │  ├─ circuitbreaker/                       # 熔断器
│  │  │  ├─ config/                            # 熔断器配置
│  │  │  ├─ state/                             # 状态管理
│  │  │  └─ metrics/                           # 熔断器指标
│  │  ├─ retry/                                # 重试机制
│  │  │  ├─ policy/                            # 重试策略
│  │  │  ├─ backoff/                           # 退避算法
│  │  │  └─ exception/                         # 异常处理
│  │  └─ bulkhead/                             # 舱壁隔离
│  ├─ exception/                               # 异常处理组件
│  │  ├─ handler/                              # 全局异常处理器
│  │  ├─ error/                                # 错误码定义
│  │  ├─ response/                             # 统一响应格式
│  │  └─ advice/                               # 异常处理建议
│  ├─ validation/                              # 数据验证组件
│  │  ├─ annotation/                           # 自定义验证注解
│  │  ├─ validator/                            # 自定义验证器
│  │  ├─ group/                                # 验证分组
│  │  └─ message/                              # 验证消息
│  ├─ response/                                # 统一响应组件
│  │  ├─ wrapper/                              # 响应包装器
│  │  ├─ code/                                 # 响应码定义
│  │  ├─ page/                                 # 分页响应
│  │  └─ format/                               # 响应格式化
│  ├─ audit/                                   # 审计日志组件
│  │  ├─ annotation/                           # 审计注解
│  │  ├─ handler/                              # 审计处理器
│  │  ├─ model/                                # 审计模型
│  │  └─ storage/                              # 审计存储
│  ├─ config/                                  # 配置管理组件
│  │  ├─ refresh/                              # 配置刷新
│  │  ├─ encryption/                           # 配置加密
│  │  ├─ validation/                           # 配置验证
│  │  └─ watcher/                              # 配置监听
│  ├─ lock/                                    # 分布式锁组件
│  │  ├─ redis/                                # Redis分布式锁
│  │  │  ├─ redisson/                          # Redisson实现
│  │  │  ├─ lettuce/                           # Lettuce实现
│  │  │  └─ config/                            # Redis锁配置
│  │  ├─ annotation/                           # 锁注解
│  │  │  ├─ distributedLock/                   # 分布式锁注解
│  │  │  ├─ lockKey/                           # 锁键生成
│  │  │  └─ lockTimeout/                       # 锁超时配置
│  │  └─ strategy/                             # 锁策略
│  │     ├─ retry/                             # 重试策略
│  │     ├─ timeout/                           # 超时策略
│  │     └─ fallback/                          # 降级策略
│  ├─ utils/                                   # 工具组件
│  │  ├─ cache/                                # 缓存管理
│  │  │  ├─ local/                             # 本地缓存
│  │  │  ├─ distributed/                       # 分布式缓存
│  │  │  └─ config/                            # 缓存配置
│  │  ├─ queue/                                # 消息队列
│  │  │  ├─ producer/                          # 生产者
│  │  │  ├─ consumer/                          # 消费者
│  │  │  └─ config/                            # 队列配置
│  │  ├─ logging/                              # 日志组件
│  │  │  ├─ config/                            # 日志配置
│  │  │  ├─ formatter/                         # 日志格式化
│  │  │  ├─ appender/                          # 日志输出器
│  │  │  └─ filter/                            # 日志过滤器
│  │  └─ monitoring/                           # 监控组件
│  │     ├─ metrics/                           # 指标收集
│  │     ├─ health/                            # 健康检查
│  │     ├─ tracing/                           # 链路追踪
│  │     └─ alerting/                          # 告警组件
│  └─ security/                                # 安全组件
│     ├─ jwt/                                  # JWT认证
│     │  ├─ config/                            # JWT配置
│     │  ├─ generator/                         # JWT生成器
│     │  ├─ validator/                         # JWT验证器
│     │  └─ refresh/                           # 刷新令牌
│     ├─ permission/                           # 权限控制
│     │  ├─ config/                            # 权限配置
│     │  ├─ checker/                           # 权限检查器
│     │  ├─ cache/                             # 权限缓存
│     │  └─ annotation/                        # 权限注解
│     ├─ encryption/                           # 加密解密
│     │  ├─ config/                            # 加密配置
│     │  ├─ algorithm/                         # 加密算法
│     │  ├─ key/                               # 密钥管理
│     │  └─ utils/                             # 加密工具
│     └─ rateLimit/                            # 限流组件
│        ├─ config/                            # 限流配置
│        ├─ algorithm/                         # 限流算法
│        ├─ storage/                           # 限流存储
│        └─ annotation/                        # 限流注解
└─ src/main/resources/
   ├─ application.yml                          # 配置文件
   ├─ logback-spring.xml                       # 日志配置
   └─ META-INF/
```

---

## 4. 公共模块组件说明

### 4.1 公共模块设计原则

#### 4.1.1 抽离原则
- **高复用性**：多个服务都需要使用的功能
- **低耦合性**：不依赖特定业务逻辑，可独立测试部署
- **高内聚性**：功能相关性强，职责单一明确
- **标准化**：遵循行业标准，易于理解和维护

#### 4.1.2 组件分类
- **基础设施组件**：数据库、Redis、MinIO、NATS、WebSocket基础
- **服务治理组件**：服务发现、负载均衡、熔断器、重试机制
- **通用功能组件**：异常处理、数据验证、统一响应、审计日志
- **运维管理组件**：配置管理、分布式锁、监控告警

### 4.2 核心组件功能说明

#### 4.2.1 服务发现组件 (Discovery)
- **服务注册**：基于NATS的服务注册机制
- **服务发现**：服务实例查找和健康检查
- **负载均衡**：服务实例选择和故障转移
- **健康检查**：服务状态监控和自动下线

#### 4.2.2 负载均衡组件 (LoadBalancer)
- **轮询策略**：Round Robin，简单均衡
- **最少连接**：Least Connections，动态均衡
- **权重策略**：Weighted，支持实例权重配置
- **一致性哈希**：Consistent Hash，保证会话亲和性

#### 4.2.3 容错组件 (Resilience)
- **熔断器**：Circuit Breaker，防止级联故障
- **重试机制**：Retry Policy，指数退避重试
- **舱壁隔离**：Bulkhead，资源隔离保护
- **降级策略**：Fallback，服务降级处理

#### 4.2.4 异常处理组件 (Exception)
- **全局异常处理**：统一异常捕获和处理
- **错误码定义**：标准化的错误码体系
- **统一响应格式**：一致的API响应结构
- **异常处理建议**：异常处理最佳实践

#### 4.2.5 数据验证组件 (Validation)
- **自定义验证注解**：业务规则验证注解
- **自定义验证器**：复杂业务逻辑验证
- **验证分组**：不同场景的验证规则
- **验证消息**：友好的错误提示信息

#### 4.2.6 统一响应组件 (Response)
- **响应包装器**：统一的数据包装格式
- **响应码定义**：标准化的响应状态码
- **分页响应**：分页数据的标准格式
- **响应格式化**：不同格式的响应输出

#### 4.2.7 审计日志组件 (Audit)
- **审计注解**：操作审计的注解支持
- **审计处理器**：审计日志的自动记录
- **审计模型**：审计数据的标准模型
- **审计存储**：审计日志的存储策略

#### 4.2.8 配置管理组件 (Config)
- **配置刷新**：运行时配置动态更新
- **配置加密**：敏感配置的加密保护
- **配置验证**：配置项的有效性验证
- **配置监听**：配置变更的实时通知

#### 4.2.9 分布式锁组件 (Lock)
- **Redis分布式锁**：基于Redis的分布式锁实现
  - **Redisson实现**：高性能、功能丰富的分布式锁
  - **Lettuce实现**：轻量级、响应式的分布式锁
- **锁注解**：声明式的分布式锁使用
- **锁策略**：锁的超时、重试、降级策略

---

## 5. 数据模型设计

注：表结构定义已从本文档移除，统一维护于脚本 `im_database_init.sql` 与 `messages_sharding_design.sql`。下文各小节仅保留说明。

### 4.1 数据库设计原则

- **服务独立**：每个服务拥有自己的数据库，避免跨服务直接访问
- **数据一致性**：通过NATS事件保证最终一致性
- **分库分表**：支持水平分片，提高系统扩展性
- **读写分离**：主从架构，提高查询性能
  - **主库**: im_system (写操作、核心业务)
  - **从库**: im_system_copy (读操作、报表查询)

### 4.2 业务服务数据库

#### 4.2.1 用户管理表
表结构参见脚本：`im_database_init.sql`

#### 4.2.2 社交管理表
表结构参见脚本：`im_database_init.sql`

#### 4.2.3 内容管理表
表结构参见脚本：`im_database_init.sql`

### 4.3 通信服务数据库

#### 4.3.1 消息管理表
表结构参见脚本：`im_database_init.sql`；消息表分表方案见：`messages_sharding_design.sql`

#### 4.3.2 连接管理表
表结构参见脚本：`im_database_init.sql`

### 4.4 管理服务数据库

#### 4.4.1 监控管理表
表结构参见脚本：`im_database_init.sql`

#### 4.4.2 配置管理表
表结构参见脚本：`im_database_init.sql`

---

## 5. Redis键空间设计

### 5.1 键空间命名规范

- **格式**：`{service}:{module}:{type}:{id}`
- **示例**：`business:user:profile:123`、`comm:message:cache:456`
- **TTL策略**：根据数据特性设置合适的过期时间
- **数据库策略**：所有服务共享database 0，通过键前缀区分服务数据

### 5.2 业务服务Redis键

#### 5.2.1 用户管理键
```
# 用户信息缓存
user:profile:{userId} → hash(用户信息)
user:devices:{userId} → set(设备ID集合)
user:status:{userId} → hash(在线状态、最后活跃时间)

# 用户会话缓存
user:conversations:{userId} → list(会话ID列表)
user:pinned:{userId} → set(置顶会话ID集合)
user:muted:{userId} → set(免打扰会话ID集合)

# 用户权限缓存
user:permissions:{userId} → set(权限集合)
user:roles:{userId} → set(角色集合)
```

#### 5.2.2 社交管理键
```
# 好友关系缓存
friend:list:{userId} → set(好友ID集合)
friend:requests:{userId} → set(好友申请ID集合)
friend:blacklist:{userId} → set(黑名单ID集合)

# 群组管理缓存
group:members:{groupId} → set(成员ID集合)
group:roles:{groupId} → hash(成员ID, 角色)
group:settings:{groupId} → hash(群组设置)
group:announcements:{groupId} → list(公告列表)
```

#### 5.2.3 内容管理键
```
# 文件管理缓存
file:info:{fileId} → hash(文件信息)
file:preview:{fileId} → hash(预览信息)
file:upload:{uploadId} → hash(上传状态)

# 收藏管理缓存
favorite:list:{userId} → set(收藏ID集合)
favorite:count:{userId} → int(收藏数量)
```

### 5.3 通信服务Redis键

#### 5.3.1 消息管理键
```
# 消息缓存
message:content:{msgId} → hash(消息内容)
message:seq:{convId} → int(最新序列号)
message:unread:{convId}:{userId} → int(未读数量)

# 消息幂等性
idem:{convId}:{clientMsgId} → string(服务端消息ID)

# 消息路由
route:user:{userId} → hash(用户路由信息)
route:device:{deviceId} → hash(设备路由信息)
```

#### 5.3.2 连接管理键
```
# 连接管理
connection:{connId} → hash(连接信息)
connection:user:{userId} → set(连接ID集合)
connection:instance:{instanceId} → set(连接ID集合)

# 心跳管理
heartbeat:{connId} → int(最后心跳时间戳)
```

### 5.4 管理服务Redis键

#### 5.4.1 监控管理键
```
# 监控指标
metrics:{metricName}:{timestamp} → string(指标值)
metrics:latest:{metricName} → string(最新指标值)

# 告警管理
alert:active → set(活跃告警ID集合)
alert:rule:{ruleId} → hash(告警规则)
alert:history:{ruleId} → list(告警历史)
```

#### 5.4.2 配置管理键
```
# 配置缓存
config:{configKey} → string(配置值)
config:category:{categoryId} → set(配置项集合)
config:template:{templateId} → hash(配置模板)

# 功能开关
feature:{featureName} → string(开关状态)
feature:user:{userId}:{featureName} → string(用户级开关)
```

---

## 6. NATS事件设计

### 6.1 事件命名规范

- **格式**：`im.{service}.{action}`
- **示例**：`im.user.created`、`im.message.sent`、`im.group.member.joined`

### 6.2 核心事件定义

#### 6.2.1 用户相关事件
- 用户创建事件：`im.user.created`
- 用户状态变更事件：`im.user.status.changed`
- 用户设备上线事件：`im.user.device.online`

#### 6.2.2 消息相关事件
- 消息发送事件：`im.message.sent`
- 消息已读事件：`im.message.read`
- 消息撤回事件：`im.message.recalled`

#### 6.2.3 社交相关事件
- 好友申请事件：`im.friend.request.sent`
- 群成员加入事件：`im.group.member.joined`

#### 6.2.4 系统相关事件
- 配置变更事件：`im.config.changed`
- 系统告警事件：`im.system.alert.triggered`

### 6.3 事件处理机制

#### 6.3.1 事件发布
- 使用NATS客户端发布事件
- 支持事件序列化和反序列化
- 支持事件重试和死信队列

#### 6.3.2 事件订阅
- 使用注解方式订阅事件
- 支持事件过滤和路由
- 支持事件重放和审计

---

## 7. API设计

### 7.1 业务服务API

#### 7.1.1 用户管理API
- `POST /api/v1/users/register` - 用户注册
- `POST /api/v1/users/login` - 用户登录
- `GET /api/v1/users/{userId}` - 获取用户信息
- `PUT /api/v1/users/{userId}/profile` - 更新用户资料
- `GET /api/v1/users/{userId}/devices` - 获取用户设备列表

#### 7.1.2 社交管理API
- `POST /api/v1/social/friends/request` - 发送好友申请
- `PUT /api/v1/social/friends/request/{requestId}` - 处理好友申请
- `POST /api/v1/social/conversations` - 创建会话
- `GET /api/v1/social/conversations` - 获取会话列表
- `POST /api/v1/social/groups` - 创建群组
- `POST /api/v1/social/groups/{groupId}/members` - 添加群成员

#### 7.1.3 内容管理API
- `POST /api/v1/content/files/upload` - 上传文件
- `GET /api/v1/content/files/{fileId}` - 获取文件信息
- `POST /api/v1/content/favorites` - 添加收藏
- `GET /api/v1/content/favorites` - 获取收藏列表

### 7.2 通信服务API

#### 7.2.1 WebSocket接口
- 支持消息发送、已读回执、输入状态指示
- 基于Spring WebFlux的响应式处理
- 支持连接管理和心跳检测

#### 7.2.2 消息历史API
- `GET /api/v1/messages/conversations/{conversationId}/history` - 获取消息历史
- `POST /api/v1/messages/{messageId}/recall` - 撤回消息
- `PUT /api/v1/messages/{messageId}/edit` - 编辑消息

### 7.3 管理服务API

#### 7.3.1 系统监控API
- `GET /api/v1/admin/monitoring/metrics` - 获取监控指标
- `GET /api/v1/admin/monitoring/health` - 获取系统健康状态
- `GET /api/v1/admin/monitoring/alerts` - 获取告警列表

#### 7.3.2 配置管理API
- `GET /api/v1/admin/config/items` - 获取配置项列表
- `PUT /api/v1/admin/config/items/{key}` - 更新配置项
- `GET /api/v1/admin/config/features` - 获取功能开关列表
- `PUT /api/v1/admin/config/features/{featureName}` - 更新功能开关

---

## 8. 部署架构设计

### 8.1 生产环境部署架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                生产环境部署                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │  负载均衡器     │    │  负载均衡器     │    │      负载均衡器             │ │
│  │  (Nginx/HAProxy)│    │  (Nginx/HAProxy)│    │      (Nginx/HAProxy)        │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │
│           │                       │                       │                     │
│           ▼                       ▼                       ▼                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │  前端业务服务   │    │  前端业务服务   │    │      前端业务服务           │ │
│  │  (2-3实例)      │    │  (2-3实例)      │    │      (2-3实例)              │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │
│           │                       │                       │                     │
│           ▼                       ▼                       ▼                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │   通信服务      │    │   通信服务      │    │      通信服务               │ │
│  │  (3-5实例)      │    │  (3-5实例)      │    │      (3-5实例)              │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │
│           │                       │                       │                     │
│           ▼                       ▼                       ▼                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────────────────┐ │
│  │  后台管理服务   │    │  后台管理服务   │    │      后台管理服务           │ │
│  │  (2-3实例)      │    │  (2-3实例)      │    │      (2-3实例)              │ │
│  └─────────────────┘    └─────────────────┘    └─────────────────────────────┘ │
│           │                       │                       │                     │
│           └───────────┬───────────┴───────────┬───────────┘                     │
│                       │                       │                                 │
│                       ▼                       ▼                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐ │
│  │                             共享基础设施                                    │ │
│  │                                                                             │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │ │
│  │  │   NATS      │  │    Redis    │  │   MySQL    │  │       MinIO          │ │ │
│  │  │  集群       │  │   集群      │  │  主从      │  │      集群            │ │ │
│  │  │ 5-7个节点   │  │ 3主3从      │  │ 1主2从     │  │     4节点纠删码      │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 服务配置与扩展

#### 8.2.1 前端业务服务配置
```yaml
# application.yml
spring:
  datasource:
    primary:
      url: jdbc:mysql://localhost:3306/im_system
      username: root
      password: 123456
      driver-class-name: com.mysql.cj.jdbc.Driver
    secondary:
      url: jdbc:mysql://localhost:3306/im_system_copy
      username: root
      password: 123456
      driver-class-name: com.mysql.cj.jdbc.Driver
  redis:
    host: localhost
    port: 6379
    password: 
    database: 0
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0

nats:
  servers: nats://localhost:4222
  cluster: im-cluster

minio:
  endpoint: http://localhost:9000
  access-key: minioadmin
  secret-key: minioadmin
  bucket: im-files

server:
  port: 8080

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
```

#### 8.2.2 通信服务配置
```yaml
# application.yml
spring:
  webflux:
    websocket:
      max-frame-payload-length: 1MB
      max-message-size: 1MB

nats:
  servers: nats://localhost:4222
  cluster: im-cluster
  jetstream:
    enabled: true
    domain: im

  redis:
    host: localhost
    port: 6379
    password: 
    database: 0
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0

websocket:
  heartbeat:
    interval: 30s
    timeout: 90s
  connection:
    max-per-user: 5
    max-total: 10000
```

#### 8.2.3 后台管理服务配置
```yaml
# application.yml
spring:
  datasource:
    primary:
      url: jdbc:mysql://localhost:3306/im_system
      username: root
      password: 123456
      driver-class-name: com.mysql.cj.jdbc.Driver
    secondary:
      url: jdbc:mysql://localhost:3306/im_system_copy
      username: root
      password: 123456
      driver-class-name: com.mysql.cj.jdbc.Driver
  redis:
    host: localhost
    port: 6379
    password: 
    database: 0
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0

nats:
  servers: nats://localhost:4222
  cluster: im-cluster

minio:
  endpoint: http://localhost:9000
  access-key: minioadmin
  secret-key: minioadmin
  bucket: im-admin

monitoring:
  metrics:
    enabled: true
    export:
      prometheus:
        enabled: true
  alerting:
    enabled: true
    channels:
      email:
        enabled: true
      webhook:
        enabled: true
```

### 8.3 Docker部署配置

#### 8.3.1 前端业务服务Dockerfile
- 基于OpenJDK 17镜像
- 配置JVM参数：堆内存2GB，使用G1GC
- 暴露8080端口

#### 8.3.2 通信服务Dockerfile
- 基于OpenJDK 17镜像
- 配置JVM参数：堆内存4GB，使用G1GC
- 暴露8080和8081端口

#### 8.3.3 Docker Compose配置
```yaml
version: '3.8'

services:
  nats:
    image: nats:2.9-alpine
    ports:
      - "4222:4222"
      - "8222:8222"
    command: "-js -m 8222"
    volumes:
      - nats-data:/data
      - nats-logs:/var/log

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes

  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: im_system
    volumes:
      - mysql-data:/var/lib/mysql
      - ./sql:/docker-entrypoint-initdb.d

  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data

  business-service:
    build: ./business-service
    ports:
      - "8080:8080"
    environment:
      - DB_HOST=mysql
      - REDIS_HOST=redis
      - NATS_SERVERS=nats://nats:4222
      - MINIO_ENDPOINT=http://minio:9000
    depends_on:
      - mysql
      - redis
      - nats
      - minio

  communication-service:
    build: ./communication-service
    ports:
      - "8081:8080"
    environment:
      - REDIS_HOST=redis
      - NATS_SERVERS=nats://nats:4222
    depends_on:
      - redis
      - nats

  admin-service:
    build: ./admin-service
    ports:
      - "8082:8080"
    environment:
      - DB_HOST=mysql
      - REDIS_HOST=redis
      - NATS_SERVERS=nats://nats:4222
      - MINIO_ENDPOINT=http://minio:9000
    depends_on:
      - mysql
      - redis
      - nats
      - minio

volumes:
  nats-data:
  nats-logs:
  redis-data:
  mysql-data:
  minio-data:
```

---

## 9. 开发计划与里程碑

### 9.1 开发阶段规划

#### 9.1.1 第一阶段：基础架构搭建（4周）
- **Week 1-2**：公共模块开发
  - 基础设施组件（数据库、Redis、MinIO、NATS）
  - 工具组件（缓存、队列、日志、监控）
  - 安全组件（JWT、权限、加密、限流）

- **Week 3-4**：基础服务框架
  - 服务注册与发现
  - 配置中心
  - 监控告警基础框架

#### 9.1.2 第二阶段：核心服务开发（6周）
- **Week 5-6**：前端业务服务
  - 用户管理模块
  - 社交管理模块
  - 内容管理模块
  - 搜索服务模块

- **Week 7-8**：通信服务
  - 消息处理模块
  - 实时通信模块
  - 消息路由模块
  - 推送服务模块

- **Week 9-10**：后台管理服务
  - 系统监控模块
  - 运维管理模块
  - 配置管理模块
  - 安全审计模块

#### 9.1.3 第三阶段：集成测试与优化（4周）
- **Week 11-12**：服务集成
  - 服务间通信测试
  - 事件总线测试
  - 端到端功能测试

- **Week 13-14**：性能优化
  - 性能测试
  - 压力测试
  - 性能调优

#### 9.1.4 第四阶段：生产就绪（2周）
- **Week 15-16**：生产部署
  - 生产环境部署
  - 监控告警配置
  - 运维文档编写

### 9.2 关键里程碑

#### 9.2.1 M1：基础架构完成（Week 4）
- ✅ 公共模块开发完成
- ✅ 基础服务框架搭建完成
- ✅ 开发环境部署完成

#### 9.2.2 M2：核心服务完成（Week 10）
- ✅ 三个核心服务开发完成
- ✅ 基础功能测试通过
- ✅ 服务间通信正常

#### 9.2.3 M3：系统集成完成（Week 14）
- ✅ 端到端功能测试通过
- ✅ 性能指标达到要求
- ✅ 监控告警系统正常

#### 9.2.4 M4：生产就绪（Week 16）
- ✅ 生产环境部署完成
- ✅ 运维流程建立
- ✅ 系统正式上线

---

## 10. 风险与对策

### 10.1 技术风险

#### 10.1.1 分布式系统复杂性
- **风险**：微服务架构增加了系统复杂性
- **对策**：
  - 采用成熟的微服务框架和工具
  - 建立完善的监控和告警体系
  - 制定详细的故障处理流程

#### 10.1.2 数据一致性
- **风险**：跨服务数据一致性难以保证
- **对策**：
  - 使用NATS事件总线保证最终一致性
  - 实现Saga模式处理分布式事务
  - 建立数据补偿机制

#### 10.1.3 服务间通信
- **风险**：服务间通信可能失败
- **对策**：
  - 实现熔断器模式
  - 使用重试机制
  - 建立死信队列处理失败消息

### 10.2 业务风险

#### 10.2.1 性能风险
- **风险**：系统性能不达标
- **对策**：
  - 进行充分的性能测试
  - 实现缓存策略
  - 优化数据库查询

#### 10.2.2 安全风险
- **风险**：系统安全漏洞
- **对策**：
  - 实现完善的权限控制
  - 进行安全代码审查
  - 定期安全扫描

### 10.3 运维风险

#### 10.3.1 部署风险
- **风险**：部署过程可能失败
- **对策**：
  - 使用蓝绿部署
  - 实现自动化部署
  - 建立回滚机制

#### 10.3.2 监控风险
- **风险**：系统问题无法及时发现
- **对策**：
  - 建立完善的监控体系
  - 实现自动化告警
  - 制定应急响应流程

---

## 11. 验收标准

### 11.1 功能验收
- ✅ 用户注册、登录、个人资料管理功能正常
- ✅ 好友关系、会话管理、群组管理功能正常
- ✅ 消息发送、接收、历史查询功能正常
- ✅ 文件上传、下载、预览功能正常
- ✅ 搜索功能正常
- ✅ 后台管理功能正常

### 11.2 性能验收
- ✅ 系统支持50,000总用户，10,000日活用户
- ✅ 群组支持5,000成员，2,000同时在线
- ✅ 端到端消息延迟P95 < 200ms
- ✅ 系统响应时间P95 < 100ms

### 11.2 可靠性验收
- ✅ 系统可用性 > 99.9%
- ✅ 数据一致性保证
- ✅ 故障自动恢复
- ✅ 监控告警及时

### 11.3 安全验收
- ✅ 用户认证授权正常
- ✅ 数据加密传输
- ✅ 权限控制有效
- ✅ 审计日志完整

---

## 12. 总结

本架构设计基于三个核心微服务（前端业务服务、通信服务、后台管理服务）和公共模块，通过NATS事件总线实现服务间通信。该架构具有以下优势：

### 12.1 架构优势
- **服务独立**：每个服务可以独立开发、部署、扩展
- **技术灵活**：不同服务可以使用不同的技术栈
- **故障隔离**：单个服务故障不会影响整个系统
- **扩展性好**：可以根据负载单独扩展某个服务

### 12.2 技术特点
- **响应式架构**：基于Spring WebFlux的非阻塞异步处理
- **事件驱动**：基于NATS的事件总线通信
- **微服务架构**：服务间松耦合，高内聚
- **云原生**：支持容器化部署和云平台

### 12.3 适用场景
- 中大型IM系统
- 需要高可用性和可扩展性的系统
- 团队规模较大的项目
- 需要快速迭代和部署的项目

该架构设计为IM系统提供了坚实的基础，既满足了当前的功能需求，又为未来的扩展和演进留下了充足的空间。

---

## 13. 开发环境配置

### 13.1 开发环境连接信息

#### 13.1.1 数据库配置
- **主库**: localhost:3306
  - **用户名**: root
  - **密码**: 123456
  - **数据库**: im_system
- **从库**: localhost:3306
  - **用户名**: root
  - **密码**: 123456
  - **数据库**: im_system_copy

#### 13.1.2 Redis配置
- **主机**: localhost
- **端口**: 6379
- **密码**: 无
- **数据库**: database 0 (所有服务共享)
- **键前缀策略**:
  - 业务服务: `business:*`
  - 通信服务: `comm:*`
  - 管理服务: `admin:*`

#### 13.1.3 NATS配置
- **服务器**: nats://localhost:4222
- **管理端口**: 8222
- **集群名称**: im-cluster
- **JetStream**: 启用

#### 13.1.4 MinIO配置
- **端点**: http://localhost:9000
- **控制台**: http://localhost:9001
- **访问密钥**: minioadmin
- **秘密密钥**: minioadmin
- **存储桶**:
  - 业务服务: im-files
  - 管理服务: im-admin

### 13.2 开发环境启动顺序

1. **基础设施服务**
   - MySQL: 数据库初始化
   - Redis: 缓存服务启动
   - NATS: 消息总线启动
   - MinIO: 对象存储启动

2. **应用服务**
   - 后台管理服务: 8082端口
   - 前端业务服务: 8080端口
   - 通信服务: 8081端口

### 13.3 开发环境检查清单

- [ ] MySQL服务正常运行，主库im_system已创建
- [ ] MySQL从库im_system_copy已创建并同步
- [ ] Redis服务正常运行，可连接测试
- [ ] NATS服务正常运行，JetStream已启用
- [ ] MinIO服务正常运行，存储桶已创建
- [ ] 各服务配置文件已更新为开发环境地址
- [ ] 数据库初始化脚本已执行
- [ ] 主从数据库同步状态正常

---

## 14. 技术选型确认

### 14.1 整体技术栈概览

| 技术领域 | 技术选型 | 版本 | 说明 |
|---------|---------|------|------|
| **基础环境** | JDK | 17 LTS | 长期支持版本，性能优秀 |
| **构建工具** | Maven | 3.8+ | 依赖管理，多模块构建 |
| **容器化** | Docker | 24.0+ | 应用容器化，环境一致性 |
| **编排工具** | Docker Compose | 2.20+ | 本地开发环境编排 |

### 14.2 前端业务服务技术栈

#### 14.2.1 核心框架
| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **Web框架** | Spring Boot | 3.2+ | 快速构建Spring应用 |
| **Web层** | Spring MVC | 6.0+ | RESTful API开发 |
| **数据访问** | MyBatis-Plus | 3.5+ | ORM框架，简化数据库操作 |
| **数据库** | MySQL | 8.0+ | 主数据库，存储业务数据 |
| **缓存** | Redis | 7.0+ | 数据缓存，会话管理 |

#### 13.2.2 业务组件
| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **搜索** | MySQL FULLTEXT | 8.0+ | 全文搜索，简单高效 |
| **文件存储** | MinIO | 2023+ | 对象存储，文件管理 |
| **事件总线** | NATS | 2.9+ | 服务间通信，事件发布订阅 |
| **安全认证** | JWT | - | 无状态认证，支持多端 |
| **权限控制** | Spring Security | 6.0+ | 细粒度权限控制 |
| **WebSocket基础** | 自定义组件 | - | 消息格式、DTO、常量定义 |
| **服务发现** | NATS + 自定义 | - | 基于NATS的服务注册发现 |
| **负载均衡** | 自定义策略 | - | 多种负载均衡算法实现 |
| **熔断器** | Resilience4j | 2.0+ | 熔断、重试、舱壁隔离 |
| **异常处理** | 自定义组件 | - | 统一异常处理和响应格式 |
| **数据验证** | Bean Validation | 3.0+ | 参数校验和自定义验证 |
| **审计日志** | 自定义组件 | - | 操作审计和日志记录 |
| **配置管理** | Spring Boot Config | 3.0+ | 配置刷新和加密 |
| **分布式锁** | Redis (Redisson) | 3.24+ | 高性能分布式锁实现 |
| **Redis客户端** | Redisson + Lettuce | 3.24+ / 6.2+ | 分布式锁 + 响应式客户端 |

#### 13.2.3 开发工具
| 工具 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **API文档** | OpenAPI 3.0 | 3.0+ | API文档生成，接口测试 |
| **参数校验** | Bean Validation | 3.0+ | 请求参数校验 |
| **JSON处理** | Gson | 2.10+ | 高性能JSON序列化，Redis序列化 |
| **日志框架** | Logback | 1.4+ | 结构化日志，性能优秀 |

### 13.3 通信服务技术栈

#### 13.3.1 核心框架
| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **Web框架** | Spring Boot | 3.2+ | 应用基础框架 |
| **响应式框架** | Spring WebFlux | 6.0+ | 非阻塞异步处理 |
| **WebSocket** | Spring WebSocket | 6.0+ | 实时双向通信 |
| **网络框架** | Netty | 4.1+ | 高性能网络处理 |
| **数据库** | MySQL | 8.0+ | 消息存储，连接管理 |

#### 13.3.2 通信组件
| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **消息序列化** | Protocol Buffers | 3.21+ | 高效二进制序列化 |
| **消息队列** | NATS JetStream | 2.9+ | 消息持久化，流处理 |
| **连接管理** | Redis | 7.0+ | 连接状态，路由信息 |
| **负载均衡** | 客户端负载均衡 | - | 基于NATS的服务发现 |
| **心跳管理** | 自定义实现 | - | 连接健康检查 |

#### 13.3.3 性能优化
| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **连接池** | Netty连接池 | 4.1+ | 连接复用，性能优化 |
| **消息缓存** | Redis | 7.0+ | 热点消息缓存 |
| **序列化优化** | Protobuf | 3.21+ | 减少网络传输 |
| **异步处理** | Project Reactor | 3.5+ | 响应式编程模型 |

### 13.4 后台管理服务技术栈

#### 13.4.1 核心框架
| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **Web框架** | Spring Boot | 3.2+ | 管理后台基础框架 |
| **Web层** | Spring MVC | 6.0+ | 管理API开发 |
| **数据访问** | MyBatis-Plus | 3.5+ | 管理数据操作 |
| **数据库** | MySQL | 8.0+ | 管理数据存储 |
| **缓存** | Redis | 7.0+ | 配置缓存，监控数据 |

#### 13.4.2 监控组件
| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **指标收集** | Micrometer | 1.11+ | 应用指标收集 |
| **指标导出** | Prometheus | 2.45+ | 监控指标存储 |
| **告警管理** | AlertManager | 0.25+ | 告警规则和通知 |
| **链路追踪** | OpenTelemetry | 1.28+ | 分布式链路追踪 |
| **日志聚合** | ELK Stack | 8.8+ | 日志收集分析 |

#### 13.4.3 运维组件
| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **配置中心** | Spring Cloud Config | 4.0+ | 配置管理和分发 |
| **服务发现** | NATS | 2.9+ | 服务注册发现 |
| **健康检查** | Spring Boot Actuator | 3.2+ | 应用健康状态 |
| **部署管理** | Docker API | 24.0+ | 容器部署管理 |
| **备份恢复** | 自定义脚本 | - | 数据备份策略 |

### 13.5 公共模块技术栈

#### 13.5.1 基础设施
| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **数据库连接池** | HikariCP | 5.0+ | 高性能连接池 |
| **Redis客户端** | Lettuce | 6.2+ | 响应式Redis客户端 |
| **MinIO客户端** | MinIO Java | 8.5+ | 对象存储客户端 |
| **NATS客户端** | NATS Java | 2.16+ | 消息总线客户端 |
| **HTTP客户端** | WebClient | 6.0+ | 响应式HTTP客户端 |

#### 13.5.2 工具组件
| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **缓存管理** | Spring Cache | 6.0+ | 缓存抽象和注解 |
| **消息队列** | Spring AMQP | 3.0+ | 消息队列抽象 |
| **日志框架** | SLF4J + Logback | 2.0+ | 日志门面和实现 |
| **监控组件** | Micrometer | 1.11+ | 指标收集和导出 |
| **配置管理** | Spring Boot Config | 3.2+ | 配置属性和环境 |

#### 13.5.3 安全组件
| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **JWT处理** | JJWT | 0.12+ | JWT生成和验证 |
| **权限控制** | Spring Security | 6.0+ | 认证授权框架 |
| **加密解密** | Bouncy Castle | 1.70+ | 加密算法实现 |
| **限流组件** | Bucket4j | 8.7+ | 令牌桶限流算法 |
| **安全审计** | Spring AOP | 6.0+ | 操作日志记录 |

### 13.6 技术选型理由

#### 13.6.1 为什么选择Spring Boot 3 + JDK 17？
- **性能提升**：JDK 17相比JDK 8有显著性能提升
- **长期支持**：JDK 17是LTS版本，支持到2029年
- **生态成熟**：Spring Boot 3生态完善，社区活跃
- **响应式支持**：原生支持响应式编程模型

#### 13.6.2 为什么选择NATS作为事件总线？
- **轻量级**：相比Kafka更轻量，部署简单
- **高性能**：单机支持百万级消息/秒
- **JetStream**：支持消息持久化和流处理
- **集群支持**：原生支持集群模式

#### 13.6.3 为什么选择MySQL + Redis组合？
- **MySQL**：关系型数据库，事务支持好，适合业务数据
- **Redis**：内存数据库，性能极高，适合缓存和会话
- **生态成熟**：工具链完善，运维经验丰富
- **成本可控**：相比商业数据库成本更低

#### 13.6.4 为什么选择MinIO作为对象存储？
- **S3兼容**：完全兼容AWS S3 API
- **部署简单**：单二进制文件，部署简单
- **性能优秀**：支持纠删码，性能接近商业产品
- **开源免费**：无许可证费用

### 13.7 版本兼容性矩阵

| 组件 | 最低版本 | 推荐版本 | 最高版本 | 说明 |
|------|---------|---------|---------|------|
| **JDK** | 17.0.0 | 17.0.9 | 17.0.x | LTS版本 |
| **Spring Boot** | 3.2.0 | 3.2.8 | 3.2.x | 稳定版本 |
| **Spring Framework** | 6.0.0 | 6.0.16 | 6.0.x | 与Boot版本对应 |
| **MySQL** | 8.0.0 | 8.0.35 | 8.0.x | 8.0 LTS版本 |
| **Redis** | 7.0.0 | 7.0.15 | 7.0.x | 7.0 LTS版本 |
| **NATS** | 2.9.0 | 2.9.25 | 2.9.x | 稳定版本 |
| **MinIO** | 2023.0.0 | 2023.12.14 | 2023.x | 稳定版本 |

### 13.8 技术栈依赖关系

```
JDK 17
    ↓
Spring Boot 3.2
    ↓
├── Spring Framework 6.0
├── Spring Security 6.0
├── Spring Data 3.0
└── Spring WebFlux 6.0
    ↓
├── MyBatis-Plus 3.5
├── Redis (Lettuce)
├── NATS Java 2.16
└── MinIO Java 8.5
    ↓
├── MySQL 8.0
├── Redis 7.0
├── NATS 2.9
└── MinIO 2023
```

### 13.9 技术栈升级策略

#### 13.9.1 短期升级计划（3个月内）
- Spring Boot 3.2.x → 3.2.x+1（补丁版本）
- 安全补丁及时更新
- 依赖库版本升级

#### 13.9.2 中期升级计划（6个月内）
- 评估Spring Boot 3.3.x新特性
- 考虑JDK 17 → JDK 21升级
- 评估新版本性能提升

#### 13.9.3 长期升级计划（1年内）
- 评估Spring Boot 4.0新特性
- 考虑架构演进方向
- 评估新技术栈引入

### 13.10 技术选型风险控制

#### 13.10.1 技术成熟度风险
- **风险**：新技术栈可能存在稳定性问题
- **控制**：选择LTS版本，充分测试验证
- **监控**：建立完善的监控和告警体系

#### 13.10.2 社区支持风险
- **风险**：开源项目可能停止维护
- **控制**：选择主流技术栈，评估社区活跃度
- **备选**：准备替代技术方案

#### 13.10.3 性能风险
- **风险**：技术栈性能不达标
- **控制**：进行充分的性能测试
- **优化**：建立性能优化机制

#### 13.10.4 运维风险
- **风险**：运维复杂度增加
- **控制**：建立完善的运维流程
- **培训**：团队技术能力提升
