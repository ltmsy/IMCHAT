# IM 系统核心服务文档

## 文档概述

本文档详细描述 im-core-service 核心单体服务的设计与实现，包括：
- 网关模块：WebSocket接入、协议编解码、心跳/ACK、限流/背压
- 消息模块：会话模型管理、消息落库、序号分配、扇出、历史拉取
- 在线状态模块：用户/设备在线状态、节点路由、订阅关系缓存
- 音视频模块：WebRTC信令交换、房间管理、媒体协商

---

## 2.1 核心服务模块

### im-core-service（核心单体服务）
- **主要职责**: 
  - **网关模块**: WebSocket接入、协议编解码、心跳/ACK、限流/背压、快速校验、路由转发
  - **消息模块**: 会话模型管理、消息落库、序号seq、扇出、未读游标、历史拉取、重传
  - **在线状态模块**: 用户/设备在线状态、节点路由、订阅关系缓存、失效迁移
  - **音视频模块**: WebRTC信令交换、房间管理、媒体协商、通话状态维护
- **核心特性**: 
  - 内部模块间直接方法调用，零网络延迟
  - 共享内存和连接池，提高性能
  - 支持水平扩展，每个节点独立处理连接和消息
- **状态管理**: 维护传输层Session/Device与连接路由，支持多节点集群

### 网关模块详细结构
```
gateway/
├── connection/                  # 连接管理
│   ├── ConnectionManager.java   # 连接管理器
│   ├── ConnectionStore.java     # 连接存储
│   └── ConnectionLifecycle.java # 连接生命周期
├── protocol/                    # 协议处理
│   ├── ProtocolHandler.java     # 协议处理器
│   ├── EnvelopeDecoder.java     # 消息解码
│   └── EnvelopeEncoder.java     # 消息编码
├── session/                     # 会话管理
│   ├── SessionManager.java      # 会话管理器
│   ├── DeviceSession.java       # 设备会话
│   └── SessionStore.java        # 会话存储
├── heartbeat/                   # 心跳管理
│   ├── HeartbeatManager.java    # 心跳管理器
│   ├── HeartbeatChecker.java    # 心跳检查
│   └── IdleConnectionScanner.java # 空闲连接扫描
├── security/                    # 安全控制
│   ├── AuthHandler.java         # 认证处理
│   ├── TokenValidator.java      # Token验证
│   └── PermissionChecker.java   # 权限检查
├── limiter/                     # 限流控制
│   ├── RateLimiter.java         # 速率限制器
│   ├── ConnectionLimiter.java   # 连接数限制
│   └── MessageSizeLimiter.java  # 消息大小限制
└── push/                        # 消息推送
    ├── PushService.java         # 推送服务
    ├── BatchPusher.java         # 批量推送
    └── PriorityQueue.java       # 优先级队列
```

### 消息模块详细结构
```
message/
├── processor/                   # 消息处理
│   ├── MessageProcessor.java    # 消息处理器
│   ├── MessageValidator.java    # 消息验证
│   └── MessageRouter.java       # 消息路由
├── store/                       # 消息存储
│   ├── MessageStore.java        # 消息存储接口
│   ├── MongoMessageStore.java   # MongoDB实现
│   └── CachedMessageStore.java  # 缓存实现
├── sequence/                    # 序号管理
│   ├── SequenceGenerator.java   # 序号生成器
│   ├── ConversationSeq.java     # 会话序号
│   └── GlobalSeq.java           # 全局序号
├── delivery/                    # 消息投递
│   ├── MessageDelivery.java     # 消息投递
│   ├── DeliveryTracker.java     # 投递跟踪
│   └── RetryManager.java        # 重试管理
├── fanout/                      # 消息扇出
│   ├── FanoutManager.java       # 扇出管理器
│   ├── GroupFanout.java         # 群消息扇出
│   └── BatchFanout.java         # 批量扇出
├── history/                     # 历史消息
│   ├── HistoryService.java      # 历史服务
│   ├── TimelineStore.java       # 时间线存储
│   └── MessageSearcher.java     # 消息搜索
└── idempotent/                  # 幂等控制
    ├── IdempotentManager.java   # 幂等管理器
    ├── MessageDeduplicator.java # 消息去重
    └── IdempotentStore.java     # 幂等存储
```

### 在线状态模块详细结构
```
presence/
├── manager/                     # 状态管理
│   ├── PresenceManager.java     # 在线状态管理器
│   ├── UserPresence.java        # 用户在线状态
│   └── DevicePresence.java      # 设备在线状态
├── store/                       # 状态存储
│   ├── PresenceStore.java       # 状态存储接口
│   ├── RedisPresenceStore.java  # Redis实现
│   └── LocalPresenceCache.java  # 本地缓存
├── route/                       # 路由管理
│   ├── RouteManager.java        # 路由管理器
│   ├── RouteTable.java          # 路由表
│   └── RouteStrategy.java       # 路由策略
├── subscription/                # 订阅管理
│   ├── SubscriptionManager.java # 订阅管理器
│   ├── ConversationSubs.java    # 会话订阅
│   └── SubscriptionStore.java   # 订阅存储
├── event/                       # 事件处理
│   ├── PresenceEventHandler.java # 事件处理器
│   ├── OnlineEvent.java         # 上线事件
│   └── OfflineEvent.java        # 下线事件
└── failover/                    # 故障转移
    ├── FailoverManager.java     # 故障转移管理器
    ├── NodeMonitor.java         # 节点监控
    └── ConnectionMigrator.java  # 连接迁移
```

### 音视频模块详细结构
```
rtc/
├── signaling/                   # 信令处理
│   ├── SignalingService.java    # 信令服务
│   ├── OfferHandler.java        # Offer处理
│   └── AnswerHandler.java       # Answer处理
├── room/                        # 房间管理
│   ├── RoomManager.java         # 房间管理器
│   ├── RoomMember.java          # 房间成员
│   └── RoomStore.java           # 房间存储
├── call/                        # 通话管理
│   ├── CallManager.java         # 通话管理器
│   ├── CallSession.java         # 通话会话
│   └── CallHistory.java         # 通话历史
├── media/                       # 媒体控制
│   ├── MediaController.java     # 媒体控制器
│   ├── MediaConstraints.java    # 媒体约束
│   └── MediaStats.java          # 媒体统计
├── agora/                       # 声网集成
│   ├── AgoraTokenService.java   # 声网Token服务
│   ├── AgoraCloudRecording.java # 云端录制
│   ├── AgoraEventHandler.java   # 事件处理
│   └── AgoraConfig.java         # 声网配置
└── quality/                     # 质量监控
    ├── QualityMonitor.java      # 质量监控器
    ├── NetworkStats.java        # 网络统计
    └── QualityReporter.java     # 质量报告
```

---

## 5. 消息发送路径与权限校验

### 5.1 完整消息流程

#### 上行消息路径
```
用户 → 核心单体(网关模块) → 核心单体(消息模块) → 业务单体(权限模块) → 其他在线成员
```

#### 详细步骤

**1) 连接期鉴权（im-core-service网关模块）**
- 验证Token（JWT/签名），绑定userId/deviceId/scopes
- 建立路由：在线状态模块记录userId→nodeId, deviceId→nodeId

**2) 网关快速校验**
- 字段有效性（type、大小、必填）
- 频控/限流（用户级、会话级、来源IP/设备）
- 会话存在性本地缓存校验（短TTL）
- 黑名单/禁言快速判断

**3) 业务权限校验（通过NATS与业务服务通信）**
- 核验是否为会话成员、角色权限、禁言状态
- 配额策略（如每天图片条数）
- 缓存策略：网关/分发侧本地缓存+Redis，TTL 30~120s

**4) 分发与存储（im-core-service消息模块）**
- 幂等处理：clientMsgId去重
- 序号分配：获取并分配conversation seq
- 消息落库：批量/异步落库，按分片批量写
- 消息扇出：在线路由查询在线状态模块，推送给在线成员

**5) 回执与终态**
- 成功：Ack返回serverMsgId、seq、status=OK
- 失败：返回明确错误码，可提示重试

### 5.2 关键设计要点

#### 快速拒绝策略
- 快速拒绝在网关层，权限事实以业务服务权限校验为准
- 幂等与顺序在消息模块处理
- 多媒体采用"直传+引用"的双通道

#### 缓存策略
- 网关层：短TTL缓存，快速校验
- 消息层：中等TTL缓存，减少重复查询
- 权限层：长TTL缓存，主动失效机制

#### 内部调用优势
- **零网络延迟**: 网关、消息、在线状态模块间直接方法调用
- **共享内存**: 连接信息、用户状态、会话数据在内存中共享
- **批量处理**: 消息处理和状态更新可以批量进行
- **减少序列化**: 内部对象传递，避免Protobuf序列化开销

#### 服务间通信优化
- **权限校验**: 通过NATS与业务服务异步通信，避免阻塞
- **媒体处理**: 通过NATS与业务服务异步通信，支持异步处理
- **配置更新**: 通过NATS与管理服务异步通信，支持热更新

### 5.3 权限校验优化策略

#### 本地权限快照与双通道设计
- **本地权限快照**: 核心服务维护权限数据的本地快照缓存
  - 缓存内容: 会话成员关系、角色、禁言状态、黑名单
  - 缓存TTL: 普通会话300s，高频会话600s，敏感会话60s
  - 存储方式: 本地缓存(Caffeine) + Redis二级缓存
  - 容量控制: LRU淘汰策略，最大缓存项10万

#### 变更事件主动失效
- **事件驱动**: 权限变更时通过NATS主动推送失效事件
  - 主题: `im.auth.invalidate`，使用JetStream持久化
  - 事件内容: `{conversationId, userId, type, timestamp}`
  - 处理策略: 收到事件立即清除本地缓存，强制重新获取

#### 快速拒绝策略
- **布隆过滤器**: 维护禁言/黑名单用户的布隆过滤器
  - 更新周期: 60s或权限变更事件触发
  - 误判处理: 允许假阳性(宁可误拒绝)，禁止假阴性
  - 内存占用: 每100万用户约1MB内存

#### 超时与降级策略
- **超时控制**: 权限校验请求超时设置为300ms
- **降级策略**:
  - 超时时默认拒绝敏感操作(如群管理)
  - 普通消息可配置为"超时后放行+异步审计"
  - 记录降级事件并触发告警

### 5.4 权限校验超时决策流程

#### 权限校验时序图
```
┌─────────┐          ┌─────────┐          ┌─────────────┐          ┌─────────────┐
│ 客户端   │          │ 网关模块  │          │ 消息模块     │          │ 权限模块     │
└────┬────┘          └────┬────┘          └──────┬──────┘          └──────┬──────┘
     │                    │                      │                        │
     │   发送消息请求       │                      │                        │
     │───────────────────>│                      │                        │
     │                    │                      │                        │
     │                    │   快速校验(本地缓存)    │                        │
     │                    │─────────────────────>│                        │
     │                    │                      │                        │
     │                    │                      │    权限校验请求          │
     │                    │                      │───────────────────────>│
     │                    │                      │                        │
     │                    │                      │                        │
     │                    │                      │                        │
     │                    │                      │        超时(300ms)      │
     │                    │                      │<───────────────────────│
     │                    │                      │                        │
     │                    │                      │   查询消息/会话类型       │
     │                    │                      │───────────────────────>│
     │                    │                      │                        │
     │                    │                      │   应用默认策略矩阵        │
     │                    │                      │<──────────────────────>│
     │                    │                      │                        │
     │                    │                      │   决策: 拒绝/放行+审计    │
     │                    │                      │                        │
     │   返回结果           │                      │                        │
     │<───────────────────│<─────────────────────│                        │
     │                    │                      │                        │
     │                    │                      │   异步审计记录(如放行)    │
     │                    │                      │───────────────────────>│
     │                    │                      │                        │
```

#### 安全网策略矩阵

##### 敏感场景超时拒绝策略
| 场景类型 | 超时阈值 | 默认决策 | 审计级别 | 风险等级 |
|---------|---------|---------|---------|---------|
| 大群(>1000人) | 100ms | 拒绝 | 高 | 高 |
| 公司/学校管控群 | 150ms | 拒绝 | 高 | 高 |
| 公开群/官方群 | 200ms | 拒绝 | 中 | 中 |
| 普通群(<100人) | 300ms | 放行+审计 | 中 | 低 |
| 单聊 | 300ms | 放行+审计 | 低 | 低 |

##### 超时分级处理策略
1. **一级超时(100-150ms)**: 敏感场景直接拒绝，记录告警
2. **二级超时(150-200ms)**: 管控群拒绝，普通群放行+审计
3. **三级超时(200-300ms)**: 应用默认策略矩阵
4. **超时(>300ms)**: 触发熔断，应用保守策略

#### 默认决策策略
1. **超时判定**：权限校验请求超过300ms未返回视为超时
2. **降级触发**：
   - 单次超时：应用默认策略矩阵
   - 连续超时>3次：触发熔断，应用保守策略
   - 超时率>5%持续1分钟：触发全局降级，记录告警
3. **恢复策略**：
   - 半开状态：60秒后尝试恢复正常校验
   - 成功率>95%持续2分钟：完全恢复

#### 异常补偿措施
1. **审计记录**：所有降级决策记录详细日志，包括请求ID、用户ID、会话ID、消息类型、决策结果
2. **事后校验**：对放行的消息进行异步权限校验，发现违规时：
   - 标记消息状态为REVOKED
   - 向发送方推送撤回通知
   - 向接收方推送消息不可见通知
3. **告警升级**：超时率>10%持续5分钟触发人工介入告警

#### 限流与熔断策略
1. **限流策略**：
   - 敏感场景：超时率>3%时触发限流，降低QPS至50%
   - 普通场景：超时率>5%时触发限流，降低QPS至80%
2. **熔断策略**：
   - 连续超时>5次：熔断30秒
   - 超时率>10%持续2分钟：熔断5分钟
   - 熔断期间：敏感场景拒绝，普通场景放行+审计
3. **灰度策略**：
   - 按群组类型逐步放开超时放行策略
   - 按用户等级逐步放开超时放行策略
   - 支持动态配置调整策略参数

---

## 7. 在线状态与路由管理

### 7.1 数据模型设计

#### Redis键设计
```
presence:user:{userId} → {
  devices: [
    {deviceId, nodeId, lastSeen}
  ],
  lastActiveAt
}

route:device:{deviceId} → nodeId
subscribers:conv:{conversationId} → online userIds
```

### 7.2 读写路径

#### 连接管理
- **建立/断开**: 更新route与presence
- **心跳更新**: 更新lastSeen
- **路由查询**: 消息模块根据userId/deviceId找nodeId

#### 热点治理
- 热门大群禁用完整订阅集合
- 采用"在线查询+批量聚合推送"
- 本地缓存+短TTL，超热点键使用随机过期

### 7.3 故障处理

#### 故障漂移
- 节点下线时，将route失效
- 客户端重连到其他网关
- presence进行快速收敛

### 7.4 大群扇出优化策略

#### 扇出模式切换阈值
- **逐人推送阈值**:
  - 在线成员数 ≤ 1000: 直接推送给所有在线成员
  - 处理时间 ≤ 200ms: 直接推送

- **提示+拉取阈值**:
  - 在线成员数 > 1000: 切换为提示+拉取模式
  - 处理时间 > 200ms: 切换为提示+拉取模式
  - 消息大小 > 10KB: 切换为提示+拉取模式

- **动态调整**:
  - 监控扇出耗时，超过阈值自动调整策略
  - 支持按会话ID配置固定策略

#### 优先级队列设计
- **优先级定义**:
  - P0(最高): 系统通知、控制消息
  - P1(高): 单聊消息、小群消息
  - P2(中): 大群普通消息
  - P3(低): 大群媒体消息、历史同步

- **队列配置**:
  ```
  // 每个优先级的队列长度与处理比例
  P0: 1000条, 40%处理时间
  P1: 5000条, 30%处理时间
  P2: 10000条, 20%处理时间
  P3: 20000条, 10%处理时间
  ```

- **背压策略**:
  - 队列水位线监控: 70%/85%/95%
  - 70%水位线: 开始拒绝P3请求
  - 85%水位线: 开始拒绝P2请求
  - 95%水位线: 只接受P0请求

#### 批量处理优化
- **批量大小**:
  - 时间窗口: 5-10ms
  - 最大批量: 200条消息

- **分组策略**:
  - 按接收节点分组批量投递
  - 共享连接复用批量推送

- **监控指标**:
  - `fanout_batch_size`: 平均批量大小
  - `fanout_time_cost`: 扇出耗时
  - `fanout_queue_length`: 队列长度

### 7.5 Presence与路由一致性保障

#### 黏性路由策略
- **路由缓存**:
  - 本地缓存最近访问的1000个用户路由
  - 缓存TTL: 30秒
  - 更新策略: 成功路由时更新，失败立即失效

- **路由选择算法**:
  ```
  function getRoute(userId, deviceId) {
    // 1. 先查本地缓存
    route = localCache.get(userId + deviceId)
    if (route && !isExpired(route)) {
      return route
    }
    
    // 2. 查询Redis
    route = redisCache.get("route:device:" + deviceId)
    if (route) {
      localCache.put(userId + deviceId, route)
      return route
    }
    
    // 3. 广播查询
    return broadcastQuery(userId, deviceId)
  }
  ```

#### 快速收敛算法
- **抖动合并窗口**:
  - 合并窗口: 3秒内的上下线事件
  - 状态判定: 窗口结束时的最终状态

- **幂等事件处理**:
  - 事件ID: `{userId}-{deviceId}-{timestamp}-{nodeId}`
  - 事件有序性: 按timestamp排序，忽略过期事件

- **冲突解决策略**:
  - 多节点竞争: 使用分布式锁 `presence:lock:{userId}`
  - 锁超时: 200ms
  - 冲突处理: 以最新timestamp为准

#### 故障检测与迁移
- **节点健康检查**:
  - 心跳间隔: 5秒
  - 失败阈值: 3次连续失败判定节点下线

- **连接迁移流程**:
  1. 检测到节点下线
  2. 获取该节点的用户列表
  3. 标记这些用户为"待迁移"状态
  4. 等待客户端重连到新节点
  5. 新节点接收连接后更新路由

- **指标监控**:
  - `node_failure_count`: 节点故障次数
  - `route_migration_count`: 路由迁移次数
  - `route_inconsistency_count`: 路由不一致次数

---

## 8. 网关实现要点

### 8.1 连接管理

#### 性能目标
- 支持10万级长连接/节点
- 使用事件驱动网络库（Netty/epoll/Kqueue）

#### 内存优化
- 零拷贝/池化ByteBuf
- 限制临时对象
- 使用批量写（write coalescing）

### 8.2 限流与背压

#### 限流策略
- 用户级、会话级QPS限制
- 队列长度与消息大小限制

#### 背压处理
- 下游阻塞时应用背压
- 优先丢弃低优先级包或返回BUSY

### 8.3 编解码与校验

#### 编解码
- WS二进制帧映射Envelope
- 严格长度与字段检查
- 异常帧直接断开

#### 快速校验
- 字段、大小、黑名单、禁言、速率
- 尽量不落地日志（仅采样），避免放大器效应

---

## 9. 消息分发与历史实现

### 9.1 分片策略

#### 分片机制
- conversationId哈希分片
- 路由到对应分片队列/执行器
- 保证会话内串行

### 9.2 幂等与顺序

#### 幂等处理
- 幂等表：clientMsgId→serverMsgId, seq
- 写前查询或利用唯一索引冲突回读

#### 顺序保证
- 单会话执行器串行化
- 跨分片独立互不影响

### 9.3 存储设计

#### 冷热分层
- 热存储：最近消息（Redis/写优化引擎）
- 冷存储：长期归档（Mongo/ClickHouse/LSM-Tree引擎）

#### 批量优化
- 按分片/时间窗聚合写
- 写入前后打点

### 9.4 扇出策略

#### 群聊优化
- 小群：每成员直接路由推送
- 大群：按在线成员批量聚合，必要时走拉取提示

#### 回执处理
- 生成seq后立即ACK
- 落库失败有界重试
- 超过阈值标记DELAYED

### 9.5 数据库职责分配

#### MongoDB（消息数据）
- **维护方**: im-core-service（消息模块）
- **主要存储**: 
  - 消息内容
  - 会话时间线
  - 消息索引
- **访问方式**: 
  - 业务层（im-business-service）通过NATS请求im-core-service获取消息数据
  - 业务层不直接连接MongoDB

#### Redis（缓存数据）
- **维护方**: 各服务独立维护自己的缓存空间
  - im-core-service: 在线状态、路由信息、消息缓存
- **命名空间隔离**:
  - 使用前缀区分不同服务的缓存: `core:`
- **共享实例**: 所有服务共享Redis集群，但使用不同的命名空间

### 9.6 MongoDB消息存储设计

#### 集合设计策略
- **分片集合设计**:
  ```
  message_{shard_id}  # 按conversationId哈希分片，32个分片
  timeline_{shard_id} # 用户时间线分片，32个分片
  ```

- **分片键选择**:
  - message集合: `{ conversationId: "hashed" }`
  - timeline集合: `{ userId: "hashed" }`

- **索引设计**:
  ```
  // 消息查询索引
  { conversationId: 1, seq: 1 }        # 会话内按序号查询
  { conversationId: 1, createdAt: -1 } # 会话内按时间查询
  { clientMsgId: 1 }                   # 幂等性检查
  
  // 时间线索引
  { userId: 1, conversationId: 1, seq: 1 }  # 用户会话消息
  { userId: 1, createdAt: -1 }              # 用户全局时间线
  ```

#### 冷热分层策略
- **热数据层**:
  - 最近30天消息存储在主集合
  - Redis缓存最近会话的最新100条消息
  - 读取路径: Redis缓存 → MongoDB主集合

- **冷数据层**:
  - 超过30天的消息迁移至归档集合 `message_archive_{YYYYMM}`
  - 归档集合添加TTL索引，默认保留180天
  - 可选配置按用户级别延长保留期

- **查询路由策略**:
  - 时间范围内查询自动路由至对应集合
  - 跨冷热边界查询合并结果
  - 冷数据查询支持异步任务模式

#### 容量规划
- **存储预估**:
  - 每条消息平均大小: 1KB
  - 日消息量: 2000万条 = 20GB/日
  - 30天热数据: 600GB
  - 索引空间: 约200GB
  - 总存储需求: 约1TB(含冗余)

- **性能目标**:
  - 热数据查询P99: <50ms
  - 冷数据查询P99: <500ms
  - 写入吞吐: 5000 ops/s/节点

### 9.7 幂等与去重设计

#### 幂等存储策略
- **存储选型**:
  - 小规模系统: Redis(带TTL)
  - 大规模系统: 分表存储 + Redis缓存热点键

- **Redis实现**:
  ```
  // 键设计
  idempotent:{shard}:{clientMsgId} -> {serverMsgId, seq, timestamp}
  
  // TTL设置
  SETEX idempotent:{shard}:{clientMsgId} 604800 {value}  // 7天过期
  ```

- **分表实现**:
  ```sql
  -- 按日期分表
  CREATE TABLE idempotent_YYYYMMDD (
    client_msg_id VARCHAR(64) PRIMARY KEY,
    server_msg_id BIGINT NOT NULL,
    seq BIGINT NOT NULL,
    conversation_id VARCHAR(64) NOT NULL,
    created_at TIMESTAMP NOT NULL,
    INDEX idx_conv_id (conversation_id)
  )
  ```

#### clientMsgId规范
- **格式定义**: `{userId}-{deviceId}-{localSeq}-{timestamp}`
- **示例**: `10086-ios12345-789-1612345678`
- **生成规则**:
  - userId: 用户ID
  - deviceId: 设备唯一标识
  - localSeq: 客户端本地递增序号
  - timestamp: 毫秒级时间戳

#### 容量与清理策略
- **容量估算**:
  - 每条记录大小: 约100字节
  - 日消息量: 2000万条 = 2GB/日
  - 7天总容量: 约14GB

- **清理策略**:
  - Redis: 自动TTL过期
  - 分表: 按日期定期删除过期表
  - 保留策略: 默认7天，可按需调整

#### 热点缓解策略
- **分片算法**: `shard = hash(clientMsgId) % SHARD_COUNT`
- **本地缓存**: 最近处理的10万条消息ID
- **写入优化**: 批量写入，定期刷盘

---

## 25. 音视频服务集成方案

### 25.1 声网(Agora)集成架构

#### 集成模式
- **云服务模式**: 使用声网云服务进行音视频传输，本地系统负责信令和业务逻辑
- **服务端集成**: 通过声网服务端API进行Token生成、录制控制、事件回调
- **客户端集成**: 客户端通过声网SDK直接连接声网服务

#### 系统职责划分
- **im-core-service职责**:
  - 房间创建与管理
  - 通话邀请与信令
  - Token生成与分发
  - 通话状态同步
  - 通话记录存储
  - 质量数据收集

- **声网服务职责**:
  - 音视频数据传输
  - 媒体服务器调度
  - 音视频编解码
  - 网络质量保障
  - 云端录制(可选)

#### 接口设计
```java
// Token生成接口
public interface AgoraTokenService {
    /**
     * 生成RTC Token
     * @param channelName 频道名
     * @param uid 用户ID
     * @param role 角色(发布者/订阅者)
     * @param expireTime 过期时间(秒)
     * @return RTC Token
     */
    String generateRtcToken(String channelName, int uid, String role, int expireTime);
    
    /**
     * 生成RTM Token
     * @param userId 用户ID
     * @param expireTime 过期时间(秒)
     * @return RTM Token
     */
    String generateRtmToken(String userId, int expireTime);
}

// 云端录制接口
public interface AgoraCloudRecording {
    /**
     * 开始云端录制
     * @param channelName 频道名
     * @param uid 录制用户ID
     * @param storageConfig 存储配置
     * @return 录制ID
     */
    String startRecording(String channelName, int uid, StorageConfig storageConfig);
    
    /**
     * 停止云端录制
     * @param channelName 频道名
     * @param recordingId 录制ID
     * @return 录制文件信息
     */
    RecordingInfo stopRecording(String channelName, String recordingId);
}
```

#### 配置参数
```yaml
agora:
  appId: "your_app_id"
  appCertificate: "your_app_certificate"
  customerId: "your_customer_id"
  customerSecret: "your_customer_secret"
  recording:
    bucket: "recording-bucket"
    accessKey: "your_access_key"
    secretKey: "your_secret_key"
    region: "ap-northeast-1"
  callback:
    url: "https://your-domain.com/api/v1/agora/callback"
    authKey: "your_callback_auth_key"
```

### 25.2 通话流程

#### 一对一通话流程
```
┌─────────┐          ┌─────────────┐          ┌─────────────┐          ┌─────────────┐
│ 发起方   │          │ im-core-service │      │ 接收方       │          │ 声网服务     │
└────┬────┘          └──────┬──────┘          └──────┬──────┘          └──────┬──────┘
     │                      │                        │                        │
     │   发起通话请求         │                        │                        │
     │─────────────────────>│                        │                        │
     │                      │                        │                        │
     │                      │   创建房间              │                        │
     │                      │───────────────────────>│                        │
     │                      │                        │                        │
     │                      │   生成Token             │                        │
     │                      │────────────────────────────────────────────────>│
     │                      │                        │                        │
     │                      │   Token返回             │                        │
     │                      │<────────────────────────────────────────────────│
     │                      │                        │                        │
     │   返回Token和房间信息   │                        │                        │
     │<─────────────────────│                        │                        │
     │                      │                        │                        │
     │                      │   发送通话邀请           │                        │
     │                      │───────────────────────>│                        │
     │                      │                        │                        │
     │                      │   接受通话              │                        │
     │                      │<───────────────────────│                        │
     │                      │                        │                        │
     │                      │   生成Token             │                        │
     │                      │────────────────────────────────────────────────>│
     │                      │                        │                        │
     │                      │   Token返回             │                        │
     │                      │<────────────────────────────────────────────────│
     │                      │                        │                        │
     │                      │   返回Token和房间信息    │                        │
     │                      │───────────────────────>│                        │
     │                      │                        │                        │
     │   加入声网频道          │                        │   加入声网频道          │
     │────────────────────────────────────────────────────────────────────────>│
     │                      │                        │                        │
     │                      │                        │                        │
     │                      │                        │                        │
     │   实时音视频通话(P2P)   │                        │                        │
     │<───────────────────────────────────────────────────────────────────────>│
     │                      │                        │                        │
```

#### 群组通话流程
```
┌─────────┐          ┌─────────────┐          ┌─────────────┐          ┌─────────────┐
│ 发起方   │          │ im-core-service │      │ 多个接收方    │          │ 声网服务     │
└────┬────┘          └──────┬──────┘          └──────┬──────┘          └──────┬──────┘
     │                      │                        │                        │
     │   创建群组通话         │                        │                        │
     │─────────────────────>│                        │                        │
     │                      │                        │                        │
     │                      │   创建房间              │                        │
     │                      │───────────────────────>│                        │
     │                      │                        │                        │
     │                      │   生成Token             │                        │
     │                      │────────────────────────────────────────────────>│
     │                      │                        │                        │
     │                      │   Token返回             │                        │
     │                      │<────────────────────────────────────────────────│
     │                      │                        │                        │
     │   返回Token和房间信息   │                        │                        │
     │<─────────────────────│                        │                        │
     │                      │                        │                        │
     │                      │   发送群组通话邀请        │                        │
     │                      │───────────────────────>│                        │
     │                      │                        │                        │
     │   加入声网频道          │                        │                        │
     │────────────────────────────────────────────────────────────────────────>│
     │                      │                        │                        │
     │                      │                        │   接受通话(多个成员)      │
     │                      │<───────────────────────│                        │
     │                      │                        │                        │
     │                      │   为每个成员生成Token     │                        │
     │                      │────────────────────────────────────────────────>│
     │                      │                        │                        │
     │                      │   Token返回(批量)        │                        │
     │                      │<────────────────────────────────────────────────│
     │                      │                        │                        │
     │                      │   返回Token和房间信息    │                        │
     │                      │───────────────────────>│                        │
     │                      │                        │                        │
     │                      │                        │   加入声网频道(多个成员)   │
     │                      │                        │───────────────────────>│
     │                      │                        │                        │
     │                      │                        │                        │
     │   实时音视频通话(多人会议) │                      │                        │
     │<───────────────────────────────────────────────────────────────────────>│
     │                      │                        │                        │
```

### 25.3 录制与回放

#### 录制方案
- **触发条件**: 
  - 管理员开启录制功能
  - 特定会话类型自动录制(如公开会议)
  - 用户手动开启录制

- **存储策略**:
  - 录制文件存储在MinIO或云存储
  - 元数据(时长、参与者、时间)存储在MySQL
  - 录制文件链接与权限控制存储在Redis

- **录制流程**:
  1. 通过AgoraCloudRecording接口启动录制
  2. 录制过程中监控状态和存储空间
  3. 通话结束后停止录制
  4. 接收录制完成回调
  5. 更新录制元数据
  6. 生成访问链接

#### 回放权限控制
- **访问控制**:
  - 基于角色的权限控制
  - 时效性访问令牌
  - 防盗链和域名白名单
  - 水印和追溯标记

- **生命周期管理**:
  - 默认保留期: 30天
  - 重要录制: 180天
  - 自动清理策略
  - 手动归档功能

### 25.4 监控与质量保障

#### 监控指标
- **声网平台指标**:
  - 频道并发数
  - 带宽使用率
  - 通话质量分布
  - 异常掉线率

- **自定义指标**:
  - `rtc_call_success_rate`: 通话成功率
  - `rtc_call_duration_avg`: 平均通话时长
  - `rtc_token_generation_time`: Token生成时间
  - `rtc_join_channel_delay`: 加入频道延迟

#### 质量保障策略
- **预警机制**:
  - 通话质量低于阈值时告警
  - 频道异常波动监测
  - 区域性网络问题识别

- **降级策略**:
  - 视频降级为音频
  - 分辨率自动调整
  - 帧率动态控制
  - 弱网络补偿机制

---

## 文档版本信息

- **版本**: 5.0.0
- **最后更新**: 2024年
- **维护团队**: IM架构组
- **架构模式**: 分布式单体架构（核心服务+业务服务合并优化）
- **通信方式**: 服务内部直接调用 + NATS消息总线 + 共享库
- **审核状态**: 已审核 