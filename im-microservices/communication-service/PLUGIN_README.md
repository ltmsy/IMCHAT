# IMé€šä¿¡å±‚æ’ä»¶ç³»ç»Ÿ

## ğŸš€ æ¦‚è¿°

IMé€šä¿¡å±‚æ’ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäºå…¬å…±æ¨¡å—æ‰©å±•ç‚¹ç®¡ç†å™¨çš„å¯æ’æ‹”æ¶æ„ï¼Œä¸ºé€šä¿¡æœåŠ¡æä¾›äº†çµæ´»ã€å¯æ‰©å±•çš„åŠŸèƒ½æ‰©å±•èƒ½åŠ›ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

- **å¯æ’æ‹”æ¶æ„** - æ”¯æŒåŠ¨æ€åŠ è½½å’Œå¸è½½æ’ä»¶
- **æ‰©å±•ç‚¹ç®¡ç†** - ç»Ÿä¸€çš„æ‰©å±•ç‚¹å®šä¹‰å’Œæ‰§è¡Œæœºåˆ¶
- **é’©å­æœºåˆ¶** - æ”¯æŒå‰ç½®ã€åç½®ã€ç¯ç»•ã€å¼‚å¸¸ç­‰é’©å­ç±»å‹
- **ä¼˜å…ˆçº§æ§åˆ¶** - æ’ä»¶æ‰§è¡Œä¼˜å…ˆçº§ç®¡ç†
- **çƒ­æ’æ‹”** - è¿è¡Œæ—¶åŠ¨æ€å¯ç”¨/ç¦ç”¨æ’ä»¶
- **ç±»å‹å®‰å…¨** - å¼ºç±»å‹çš„æ’ä»¶æ¥å£å®šä¹‰

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é€šä¿¡å±‚æ’ä»¶ç³»ç»Ÿæ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   æ‰©å±•ç‚¹ç®¡ç†å™¨    â”‚    â”‚   æ’ä»¶æ³¨å†Œä¸­å¿ƒ    â”‚    â”‚  æ’ä»¶ç®¡ç†å™¨  â”‚ â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚    â”‚             â”‚ â”‚
â”‚  â”‚ â€¢ æ‰©å±•ç‚¹å®šä¹‰     â”‚    â”‚ â€¢ æœåŠ¡å‘ç°      â”‚    â”‚ â€¢ ç”Ÿå‘½å‘¨æœŸ   â”‚ â”‚
â”‚  â”‚ â€¢ é’©å­æ‰§è¡Œ      â”‚    â”‚ â€¢ æœåŠ¡æ³¨å†Œ      â”‚    â”‚ â€¢ ä¾èµ–ç®¡ç†   â”‚ â”‚
â”‚  â”‚ â€¢ æ‰§è¡Œç­–ç•¥      â”‚    â”‚ â€¢ äº‹ä»¶æ€»çº¿      â”‚    â”‚ â€¢ ç‰ˆæœ¬æ§åˆ¶   â”‚ â”‚
â”‚  â”‚ â€¢ ç»“æœèšåˆ      â”‚    â”‚ â€¢ æœåŠ¡ä»£ç†      â”‚    â”‚ â€¢ çƒ­æ›´æ–°     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   æ¶ˆæ¯éªŒè¯æ’ä»¶   â”‚    â”‚   è¿æ¥è®¤è¯æ’ä»¶   â”‚    â”‚  æ¶ˆæ¯è·¯ç”±æ’ä»¶ â”‚ â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚    â”‚             â”‚ â”‚
â”‚  â”‚ â€¢ å†…å®¹å®¡æ ¸      â”‚    â”‚ â€¢ JWTéªŒè¯       â”‚    â”‚ â€¢ æ™ºèƒ½è·¯ç”±   â”‚ â”‚
â”‚  â”‚ â€¢ æ•æ„Ÿè¯æ£€æµ‹    â”‚    â”‚ â€¢ OAuth2è®¤è¯    â”‚    â”‚ â€¢ è´Ÿè½½å‡è¡¡   â”‚ â”‚
â”‚  â”‚ â€¢ æ ¼å¼éªŒè¯      â”‚    â”‚ â€¢ å¤šå› å­è®¤è¯    â”‚    â”‚ â€¢ æ•…éšœè½¬ç§»   â”‚ â”‚
â”‚  â”‚ â€¢ é•¿åº¦æ£€æŸ¥      â”‚    â”‚ â€¢ è®¾å¤‡è®¤è¯      â”‚    â”‚ â€¢ åœ°ç†ä½ç½®   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”Œ å·²å®ç°çš„æ’ä»¶

### 1. æ¶ˆæ¯éªŒè¯æ’ä»¶ (MessageValidator)

**åŠŸèƒ½**ï¼šæ¶ˆæ¯å†…å®¹éªŒè¯ã€æ•æ„Ÿè¯æ£€æµ‹ã€æ ¼å¼æ£€æŸ¥ç­‰

**ç‰¹æ€§**ï¼š
- æ¶ˆæ¯é•¿åº¦é™åˆ¶ï¼ˆé»˜è®¤1000å­—ç¬¦ï¼‰
- æ•æ„Ÿè¯æ£€æµ‹å’Œè¿‡æ»¤
- å†…å®¹æ ¼å¼éªŒè¯
- å¯é…ç½®çš„éªŒè¯è§„åˆ™

**ä½¿ç”¨åœºæ™¯**ï¼š
- å†…å®¹å®¡æ ¸
- åƒåœ¾æ¶ˆæ¯è¿‡æ»¤
- åˆè§„æ€§æ£€æŸ¥

### 2. è¿æ¥è®¤è¯æ’ä»¶ (ConnectionAuthenticator)

**åŠŸèƒ½**ï¼šç”¨æˆ·èº«ä»½è®¤è¯ã€è®¾å¤‡è®¤è¯ã€æƒé™ç®¡ç†ç­‰

**ç‰¹æ€§**ï¼š
- JWT Tokenè®¤è¯
- ç”¨æˆ·åå¯†ç è®¤è¯
- OAuth2è®¤è¯
- å¤šå› å­è®¤è¯æ”¯æŒ
- è®¾å¤‡æŒ‡çº¹è¯†åˆ«

**ä½¿ç”¨åœºæ™¯**ï¼š
- ç”¨æˆ·ç™»å½•è®¤è¯
- è®¾å¤‡ç®¡ç†
- æƒé™æ§åˆ¶
- å®‰å…¨å®¡è®¡

### 3. æ¶ˆæ¯è·¯ç”±æ’ä»¶ (MessageRouter)

**åŠŸèƒ½**ï¼šæ¶ˆæ¯æ™ºèƒ½è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»ç­‰

**ç‰¹æ€§**ï¼š
- åŸºäºæ¶ˆæ¯ç±»å‹çš„æ™ºèƒ½è·¯ç”±
- è´Ÿè½½å‡è¡¡ç­–ç•¥
- æ•…éšœè½¬ç§»æœºåˆ¶
- æ€§èƒ½ä¼˜åŒ–è·¯ç”±

**ä½¿ç”¨åœºæ™¯**ï¼š
- æ¶ˆæ¯åˆ†å‘
- æœåŠ¡è´Ÿè½½å‡è¡¡
- é«˜å¯ç”¨æ€§ä¿éšœ
- æ€§èƒ½ä¼˜åŒ–

## ğŸ¯ æ‰©å±•ç‚¹å®šä¹‰

### æ¶ˆæ¯å¤„ç†æ‰©å±•ç‚¹

```java
// æ¶ˆæ¯éªŒè¯æ‰©å±•ç‚¹
"message.validate" - æ¶ˆæ¯éªŒè¯æ‰©å±•ç‚¹ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¶ˆæ¯éªŒè¯è§„åˆ™

// æ¶ˆæ¯è¿‡æ»¤æ‰©å±•ç‚¹  
"message.filter" - æ¶ˆæ¯è¿‡æ»¤æ‰©å±•ç‚¹ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¶ˆæ¯è¿‡æ»¤é€»è¾‘

// æ¶ˆæ¯å¤„ç†æ‰©å±•ç‚¹
"message.process" - æ¶ˆæ¯å¤„ç†æ‰©å±•ç‚¹ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¶ˆæ¯å¤„ç†é€»è¾‘

// æ¶ˆæ¯è·¯ç”±æ‰©å±•ç‚¹
"message.route" - æ¶ˆæ¯è·¯ç”±æ‰©å±•ç‚¹ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¶ˆæ¯è·¯ç”±é€»è¾‘

// è¿æ¥è®¤è¯æ‰©å±•ç‚¹
"connection.authenticate" - è¿æ¥è®¤è¯æ‰©å±•ç‚¹ï¼Œæ”¯æŒè‡ªå®šä¹‰è®¤è¯é€»è¾‘
```

### WebSocketé’©å­æ‰©å±•ç‚¹

```java
// WebSocketæ¶ˆæ¯å¤„ç†é’©å­
"websocket.message.before.process" - æ¶ˆæ¯å¤„ç†å‰é’©å­
"websocket.message.after.process" - æ¶ˆæ¯å¤„ç†åé’©å­  
"websocket.message.on.error" - æ¶ˆæ¯å¤„ç†å¼‚å¸¸é’©å­
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºè‡ªå®šä¹‰æ’ä»¶

```java
@Component
public class CustomMessageValidator implements MessageValidator {
    
    @Override
    public ValidationResult validateMessage(Object message, ValidationContext context) {
        // è‡ªå®šä¹‰éªŒè¯é€»è¾‘
        if (containsCustomRule(message)) {
            return ValidationResult.failure("custom_validation", "è¿åè‡ªå®šä¹‰è§„åˆ™");
        }
        return ValidationResult.success("custom_validation");
    }
    
    @Override
    public String getValidatorName() {
        return "CustomMessageValidator";
    }
    
    @Override
    public int getPriority() {
        return 50; // é«˜ä¼˜å…ˆçº§
    }
    
    @Override
    public boolean supportsMessageType(String messageType) {
        return "text".equals(messageType);
    }
    
    @Override
    public List<String> getSupportedValidationTypes() {
        return List.of("custom_validation");
    }
}
```

### 2. æ³¨å†Œæ‰©å±•ç‚¹

```java
@Configuration
public class CustomPluginConfig {
    
    @Autowired
    private ExtensionPointManager extensionPointManager;
    
    @PostConstruct
    public void registerCustomExtensionPoints() {
        extensionPointManager.defineExtensionPoint(
            "custom.validation",
            "è‡ªå®šä¹‰éªŒè¯æ‰©å±•ç‚¹",
            CustomValidator.class,
            ExecutionStrategy.ALL,
            false,
            50,
            Map.of("category", "custom", "version", "1.0")
        );
    }
}
```

### 3. ä½¿ç”¨æ‰©å±•ç‚¹

```java
@Service
public class MessageService {
    
    @Autowired
    private ExtensionPointManager extensionPointManager;
    
    public void processMessage(Message message) {
        // æ‰§è¡Œè‡ªå®šä¹‰éªŒè¯æ‰©å±•ç‚¹
        extensionPointManager.executeExtensionPoint("custom.validation", 
            new Object[]{message, createContext()});
    }
}
```

## ğŸ§ª æµ‹è¯•

### è¿è¡Œå•å…ƒæµ‹è¯•

```bash
mvn test -Dtest=PluginUnitTest
```

### è¿è¡Œæ¼”ç¤ºç¨‹åº

```bash
mvn test-compile
java -cp "target/classes:target/test-classes:$(mvn dependency:build-classpath -q -Dmdep.outputFile=/dev/stdout)" \
     com.acme.im.communication.plugin.PluginDemo
```

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

- **å¼‚æ­¥æ‰§è¡Œ** - æ”¯æŒå¼‚æ­¥æ‰©å±•ç‚¹æ‰§è¡Œ
- **æ‰¹é‡å¤„ç†** - æ”¯æŒæ‰¹é‡æ¶ˆæ¯å¤„ç†
- **ç¼“å­˜æœºåˆ¶** - æ’ä»¶ç»“æœç¼“å­˜
- **ç›‘æ§ç»Ÿè®¡** - æ‰©å±•ç‚¹æ‰§è¡Œæ€§èƒ½ç»Ÿè®¡
- **ç†”æ–­ä¿æŠ¤** - æ’ä»¶æ‰§è¡Œå¼‚å¸¸ä¿æŠ¤

## ğŸ”§ é…ç½®è¯´æ˜

### æ’ä»¶é…ç½®

```yaml
# application.yml
plugin:
  system:
    enabled: true
    auto-discovery: true
    hot-reload: true
    max-execution-time: 5000ms
    circuit-breaker:
      enabled: true
      failure-threshold: 5
      recovery-timeout: 30s
```

### æ‰©å±•ç‚¹é…ç½®

```yaml
# æ‰©å±•ç‚¹ä¼˜å…ˆçº§é…ç½®
extension-points:
  message.validate:
    default-priority: 100
    execution-strategy: ALL
    required: false
  connection.authenticate:
    default-priority: 200
    execution-strategy: UNTIL_SUCCESS
    required: true
```

## ğŸš€ éƒ¨ç½²è¯´æ˜

### 1. å¼€å‘ç¯å¢ƒ

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd im-microservices/communication-service

# ç¼–è¯‘é¡¹ç›®
mvn clean compile

# è¿è¡Œæµ‹è¯•
mvn test

# å¯åŠ¨æœåŠ¡
mvn spring-boot:run
```

### 2. ç”Ÿäº§ç¯å¢ƒ

```bash
# æ‰“åŒ…
mvn clean package -DskipTests

# è¿è¡Œ
java -jar target/communication-service-1.0.0-SNAPSHOT.jar
```

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æ‰©å±•ç‚¹ç»Ÿè®¡

```java
@RestController
public class PluginMonitorController {
    
    @Autowired
    private ExtensionPointManager extensionPointManager;
    
    @GetMapping("/plugin/stats")
    public Map<String, Object> getPluginStats() {
        return extensionPointManager.getAllExecutionStats();
    }
}
```

### æ—¥å¿—é…ç½®

```yaml
# logback-spring.xml
<logger name="com.acme.im.common.plugin" level="DEBUG"/>
<logger name="com.acme.im.communication.plugin" level="DEBUG"/>
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

### å¼€å‘æ–°æ’ä»¶

1. å®ç°ç›¸åº”çš„æ’ä»¶æ¥å£
2. æ·»åŠ å•å…ƒæµ‹è¯•
3. æ›´æ–°æ–‡æ¡£
4. æäº¤Pull Request

### ä»£ç è§„èŒƒ

- éµå¾ªJavaç¼–ç è§„èŒƒ
- æ·»åŠ å®Œæ•´çš„JavaDocæ³¨é‡Š
- ç¡®ä¿æµ‹è¯•è¦†ç›–ç‡ > 80%
- ä½¿ç”¨Lombokç®€åŒ–ä»£ç 

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å…¬å…±æ¨¡å—æ’ä»¶ç³»ç»Ÿ](../common/README.md)
- [æ‰©å±•ç‚¹ç®¡ç†å™¨APIæ–‡æ¡£](../common/src/main/java/com/acme/im/common/plugin/ExtensionPointManager.java)
- [æ’ä»¶æ³¨å†Œä¸­å¿ƒAPIæ–‡æ¡£](../common/src/main/java/com/acme/im/common/plugin/PluginRegistry.java)

## ğŸ†˜ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æ·»åŠ æ–°çš„æ‰©å±•ç‚¹ç±»å‹ï¼Ÿ
A: åœ¨`CommunicationPluginConfig`ä¸­å®šä¹‰æ–°çš„æ‰©å±•ç‚¹ï¼Œå®ç°ç›¸åº”çš„æ¥å£ï¼Œç„¶åæ³¨å†Œåˆ°æ‰©å±•ç‚¹ç®¡ç†å™¨ã€‚

### Q: æ’ä»¶æ‰§è¡Œå¤±è´¥æ€ä¹ˆåŠï¼Ÿ
A: æ£€æŸ¥æ’ä»¶æ—¥å¿—ï¼Œç¡®è®¤æ’ä»¶é…ç½®æ­£ç¡®ï¼ŒéªŒè¯æ‰©å±•ç‚¹æ˜¯å¦æ­£ç¡®æ³¨å†Œã€‚

### Q: å¦‚ä½•æé«˜æ’ä»¶æ‰§è¡Œæ€§èƒ½ï¼Ÿ
A: ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œã€ç»“æœç¼“å­˜ã€æ‰¹é‡å¤„ç†ç­‰ä¼˜åŒ–ç­–ç•¥ã€‚

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](../LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ‘¥ å›¢é˜Ÿ

- **æ¶æ„è®¾è®¡** - IMå¼€å‘å›¢é˜Ÿ
- **æ’ä»¶å¼€å‘** - IMå¼€å‘å›¢é˜Ÿ
- **æµ‹è¯•éªŒè¯** - IMå¼€å‘å›¢é˜Ÿ

---

**ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-08-13  
**ç»´æŠ¤è€…**: IMå¼€å‘å›¢é˜Ÿ 