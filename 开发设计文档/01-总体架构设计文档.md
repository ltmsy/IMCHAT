# IM 系统总体架构设计文档

## 文档概述

本文档提供基于分布式单体架构的即时通讯（IM）系统完整设计方案，覆盖：
- 模块边界与职责划分
- 协议契约与数据模型
- 消息路径与权限校验
- 媒体处理与存储策略
- 观测运维与安全设计
- NATS消息总线通信设计
- 共享库与公共组件设计

**技术栈**: 支持 Java/Kotlin/Go/Node 等语言，示例以通用术语描述

---

## 0. 架构图与流程图总览

### 0.1 分布式单体架构总览图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   客户端层                                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │  Web客户端   │ │  移动端APP   │ │  桌面客户端   │ │  第三方API   │ │  管理后台    │ │
│  │ (WebSocket) │ │ (WebSocket) │ │ (WebSocket) │ │   (HTTP)    │ │   (HTTP)    │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   负载均衡层                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                    Nginx/HAProxy + SSL终端                                    │ │
│  │  WebSocket路由 → 核心服务集群    HTTP API路由 → 业务服务集群                    │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                分布式单体服务层                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                    im-core-service 核心单体                             │ │ │
│  │  │                                                                             │ │ │
│  │  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐               │ │ │
│  │  │  │   网关模块      │ │   消息模块      │ │   在线状态模块   │               │ │ │
│  │  │  │ (Gateway)       │ │ (Message)       │ │ (Presence)      │               │ │ │
│  │  │  │                 │ │                 │ │                 │               │ │ │
│  │  │  │ • WebSocket接入  │ │ • 会话模型管理   │ │ • 用户在线状态   │               │ │ │
│  │  │  │ • 协议编解码     │ │ • 消息落库      │ │ • 节点路由      │               │ │ │
│  │  │  │ • 心跳/ACK      │ │ • 序号分配      │ │ • 订阅关系缓存   │               │ │ │
│  │  │  │ • 限流/背压     │ │ • 消息扇出      │ │ • 故障漂移      │               │ │ │
│  │  │  │ • 快速校验      │ │ • 历史拉取      │ │ • 热点治理      │               │ │ │
│  │  │  │ • 路由转发      │ │ • 重传机制      │ │ • 快速收敛      │               │ │ │
│  │  │  └─────────────────┘ └─────────────────┘ └─────────────────┘               │ │ │
│  │  │                                                                             │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │ │
│  │  │  │                           共享组件                                     │ │ │ │
│  │  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐ │ │ │ │
│  │  │  │  │ 缓存管理    │ │ 配置管理    │ │ 监控埋点    │ │ 错误处理        │ │ │ │ │
│  │  │  │  │ • Redis客户端│ │ • 配置热更新 │ │ • 指标收集  │ │ • 统一异常      │ │ │ │ │
│  │  │  │  │ • 本地缓存  │ │ • 环境配置  │ │ • 链路追踪  │ │ • 错误码        │ │ │ │ │
│  │  │  │  │ • 缓存策略  │ │ • 动态配置  │ │ • 日志记录  │ │ • 降级策略      │ │ │ │ │
│  │  │  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘ │ │ │ │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                                 │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                    im-business-service 业务单体                            │ │ │
│  │  │                                                                             │ │ │
│  │  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐               │ │ │
│  │  │  │   权限模块      │ │   媒体模块      │ │   定时任务模块   │               │ │ │
│  │  │  │ (Auth)          │ │ (Media)         │ │ (Scheduler)     │               │ │ │
│  │  │  │                 │ │                 │ │                 │               │ │ │
│  │  │  │ • 群成员关系     │ │ • 媒体直传签发   │ │ • 定时任务调度   │               │ │ │
│  │  │  │ • 角色权限       │ │ • 上传鉴权配额   │ │ • 数据清理      │               │ │ │
│  │  │  │ • 禁言黑名单     │ │ • 转码/缩略图    │ │ • 统计报表      │               │ │ │
│  │  │  │ • 会话权限核验   │ │ • 内容安全      │ │ • 数据同步      │               │ │ │
│  │  │  │ • 权限缓存      │ │ • 存储管理      │ │ • 监控告警      │               │ │ │
│  │  │  └─────────────────┘ └─────────────────┘ └─────────────────┘               │ │ │
│  │  │                                                                             │ │ │
│  │  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │ │
│  │  │  │                           共享组件                                     │ │ │ │
│  │  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐ │ │ │ │
│  │  │  │  │ 缓存管理    │ │ 配置管理    │ │ 监控埋点    │ │ 错误处理        │ │ │ │ │
│  │  │  │  │ • Redis客户端│ │ • 配置热更新 │ │ • 指标收集  │ │ • 统一异常      │ │ │ │ │
│  │  │  │  │ • 本地缓存  │ │ • 环境配置  │ │ • 链路追踪  │ │ • 错误码        │ │ │ │ │
│  │  │  │  │ • 缓存策略  │ │ • 动态配置  │ │ • 日志记录  │ │ • 降级策略      │ │ │ │ │
│  │  │  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘ │ │ │ │
│  │  │  └─────────────────────────────────────────────────────────────────────────┘ │ │ │
│  │  └─────────────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                                 │ │
│  │  ┌─────────────────┐                                                           │ │
│  │  │ im-admin-       │                                                           │ │
│  │  │ service         │                                                           │ │
│  │  │ (管理运维)       │                                                           │ │
│  │  │                 │                                                           │ │
│  │  │ • 配置管理      │                                                           │ │
│  │  │ • 限流策略      │                                                           │ │
│  │  │ • 灰度发布      │                                                           │ │
│  │  │ • 数据校验      │                                                           │ │
│  │  │ • 审计合规      │                                                           │ │
│  │  └─────────────────┘                                                           │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                 NATS消息总线                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │ │
│  │  │ 消息主题     │ │ 状态主题     │ │ 权限主题     │ │ 媒体主题     │ │ 管理主题     │ │ │
│  │  │             │ │             │ │             │ │             │ │             │ │ │
│  │  │ • im.message│ • im.presence│ • im.auth    │ • im.media   │ • im.admin   │ │ │
│  │  │ • im.deliver│ • im.route   │ • im.member  │ • im.upload  │ • im.config  │ │ │
│  │  │ • im.ack    │ • im.status  │ • im.group   │ • im.process │ • im.monitor │ │ │
│  │  │ • im.history│ • im.subscribe│ • im.ban    │ • im.scan    │ • im.audit   │ │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                  基础设施层                                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │    MySQL    │ │    Redis    │ │  MongoDB    │ │    MinIO    │ │ Prometheus  │ │
│  │  (主从)     │ │  (Cluster)  │ │  (副本集)   │ │  对象存储    │ │   监控采集   │ │
│  │   业务数据   │ │   缓存数据   │ │   消息数据   │ │   媒体文件   │ │   指标数据   │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │   Grafana   │ │     ELK     │ │  XXL-Job    │ │   NATS      │ │  共享库     │ │
│  │   监控展示   │ │   日志分析   │ │   任务调度   │ │  消息总线   │ │   公共组件   │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 0.2 服务间通信架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                NATS消息总线通信架构                                │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                            im-core-service 核心单体                            │ │
│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                   │ │
│  │  │   网关模块      │ │   消息模块      │ │   在线状态模块   │                   │ │
│  │  │                 │ │                 │ │                 │                   │ │
│  │  │ • 内部方法调用  │ │ • 内部方法调用  │ │ • 内部方法调用  │                   │ │
│  │  │ • 零网络延迟    │ │ • 零序列化开销  │ │ • 共享内存      │                   │ │
│  │  │ • 共享连接池    │ │ • 批量处理      │ │ • 快速路由      │                   │ │
│  │  └─────────────────┘ └─────────────────┘ └─────────────────┘                   │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                               │
│                                    │ NATS通信                                      │
│                                    ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                            im-business-service 业务单体                        │ │
│  │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐                   │ │
│  │  │   权限模块      │ │   媒体模块      │ │   定时任务模块   │                   │ │
│  │  │                 │ │                 │ │                 │                   │ │
│  │  │ • 内部方法调用  │ │ • 内部方法调用  │ │ • 内部方法调用  │                   │ │
│  │  │ • 零网络延迟    │ │ • 零序列化开销  │ │ • 共享内存      │                   │ │
│  │  │ • 权限缓存      │ │ • 媒体处理      │ │ • 任务调度      │                   │ │
│  │  └─────────────────┘ └─────────────────┘ └─────────────────┘                   │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                    │                                               │
│                                    │ NATS通信                                      │
│                                    ▼                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              管理服务集群                                      │ │
│  │  ┌─────────────────┐                                                           │ │
│  │  │ im-admin-       │                                                           │ │
│  │  │ service         │                                                           │ │
│  │  │                 │                                                           │ │
│  │  │ • 订阅配置      │                                                           │ │
│  │  │ • 发布监控      │                                                           │ │
│  │  │ • 查询统计      │                                                           │ │
│  │  └─────────────────┘                                                           │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                     │
│  通信模式说明:                                                                       │
│  • 核心服务内部: 直接方法调用，零延迟，共享内存                                    │
│  • 业务服务内部: 直接方法调用，零延迟，共享内存                                    │
│  • 服务间通信: 通过NATS异步通信，松耦合                                           │
│  • 优势: 减少网络调用，降低延迟，提高吞吐量                                       │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 0.7 服务部署与扩展架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                服务部署与扩展架构                                  │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                            核心服务集群 (4节点) - 必须集群                      │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │ │
│  │  │  核心节点1   │ │  核心节点2   │ │  核心节点3   │ │  核心节点4   │               │ │
│  │  │  16C32G     │ │  16C32G     │ │  16C32G     │ │  16C32G     │               │ │
│  │  │ 2.5万连接   │ │ 2.5万连接   │ │ 2.5万连接   │ │ 2.5万连接   │               │ │
│  │  │ 8000 QPS    │ │ 8000 QPS    │ │ 8000 QPS    │ │ 8000 QPS    │               │ │
│  │  │ 网关+消息+状态│ │ 网关+消息+状态│ │ 网关+消息+状态│ │ 网关+消息+状态│               │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                            业务服务集群 (3节点) - 建议集群                      │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                               │ │
│  │  │  业务节点1   │ │  业务节点2   │ │  业务节点3   │                               │ │
│  │  │  8C16G      │ │  8C16G      │ │  8C16G      │                               │ │
│  │  │ 权限+媒体+任务│ │ 权限+媒体+任务│ │ 权限+媒体+任务│                               │ │
│  │  │ 端口:8085   │ │ 端口:8086   │ │ 端口:8087   │                               │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘                               │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              管理服务 (2节点) - 主备即可                        │ │
│  │  ┌─────────────┐ ┌─────────────┐                                               │ │
│  │  │  管理节点1   │ │  管理节点2   │                                               │ │
│  │  │  4C8G       │ │  4C8G       │                                               │ │
│  │  │ 端口:8088   │ │ 端口:8089   │                                               │ │
│  │  └─────────────┘ └─────────────┘                                               │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              基础设施层                                        │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │ │
│  │  │    NATS     │ │    Redis    │ │  MongoDB    │ │    MySQL    │               │ │
│  │  │  3节点集群   │ │ 3主3从集群  │ │ 3节点副本集  │ │  主从部署   │               │ │
│  │  │ 端口:4222   │ │ 端口:6379   │ │ 端口:27017  │ │ 端口:3306   │               │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐               │ │
│  │  │    MinIO    │ │ Prometheus  │ │   Grafana   │ │    ELK      │               │ │
│  │  │  4节点集群   │ │  2节点集群   │ │  2节点集群   │ │  3节点集群  │               │ │
│  │  │ 端口:9000   │ │ 端口:9090   │ │ 端口:3000   │ │ 端口:9200   │               │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘               │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                     │
│  扩展策略说明:                                                                       │
│  • 水平扩展: 核心服务和业务服务可以独立扩缩容，通过负载均衡                        │
│  • 垂直扩展: 单个节点可以增加CPU/内存资源                                        │
│  • 故障隔离: 单个服务故障不影响其他服务                                          │
│  • 灰度发布: 支持按版本标签路由，快速回滚                                        │
│  • 优势: 核心功能集中，减少网络调用，提高性能                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 1. 架构总览与设计原则

### 1.1 架构定位
- **架构模式**: 分布式单体架构
- **部署策略**: 3个独立单体服务，通过NATS消息总线通信，共享数据库避免分布式事务复杂性
- **核心优化**: 
  - 网关、消息、在线状态合并为核心单体，减少网络调用，提高性能
  - 权限、媒体、定时任务合并为业务单体，简化部署，提高资源利用率

### 1.2 核心设计原则
- **边界清晰**: 传输与业务分离、权限与会话分离、在线与分发分离
- **通信解耦**: 核心服务内部直接调用，业务服务内部直接调用，服务间通过NATS异步通信
- **性能优先**: 低延迟路径最短化，边缘缓存与就近校验，内部零网络延迟
- **可观测性**: 指标、日志、Trace 三位一体，优先可回溯性
- **单体优势**: 保持单体的简单性，具备分布式的扩展性

---

## 16. 分布式架构实施路线

### 16.1 实施阶段

#### 阶段1：基础架构搭建
- 搭建NATS消息总线集群
- 建立共享数据库和缓存
- 配置基础监控和日志

#### 阶段2：核心服务开发
- 开发im-core-service核心单体（网关+消息+在线状态+音视频）
- 开发im-business-service业务单体（权限+媒体+XXL-Job任务）
- 开发im-admin-service管理服务
- 实现NATS通信接口

#### 阶段3：集成测试与优化
- 端到端功能测试
- 性能测试和压力测试
- 监控告警体系完善

#### 阶段4：生产环境部署
- 灰度发布和流量切换
- 生产环境监控和运维
- 持续优化和迭代

---

## 17. 分布式架构优势与特点

### 17.1 相比微服务的优势

#### 部署运维优势
- **部署简单**: 核心服务一个JAR包，业务服务一个JAR包，无需复杂的容器编排
- **运维友好**: 不需要服务发现、熔断、链路追踪等复杂组件
- **资源管理**: 每个服务独立管理资源，避免资源竞争

#### 开发效率优势
- **共享数据库**: 避免分布式事务的复杂性
- **技术栈统一**: 所有服务使用相同的技术栈，降低学习成本
- **代码复用**: 共享库和公共组件，减少重复开发

#### 性能优势
- **内部零延迟**: 核心服务内部直接方法调用，无网络开销
- **共享内存**: 连接信息、用户状态、会话数据在内存中共享
- **批量处理**: 支持消息批量处理，提高吞吐量

### 17.2 相比传统单体的优势

#### 扩展性优势
- **独立扩展**: 每个服务可以独立扩缩容
- **故障隔离**: 单个服务故障不影响其他服务
- **技术选型**: 不同服务可以使用最适合的技术栈

#### 团队协作优势
- **并行开发**: 多个团队可以并行开发不同服务
- **职责清晰**: 每个服务职责明确，边界清晰
- **独立测试**: 每个服务可以独立测试和部署

### 17.3 架构特点总结

#### 核心特征
- **分布式**: 3个服务分布式部署，通过NATS通信
- **单体**: 核心服务和业务服务内部保持单体架构的简单性
- **共享**: 共享数据库、缓存、配置等基础设施
- **异步**: 基于消息的异步通信，松耦合设计
- **高性能**: 核心服务和业务服务内部零网络延迟，共享内存

### 17.4 共享库优势

#### 代码复用与一致性
- **统一标准**: 所有服务使用相同的通信模式、错误处理、监控方式
- **减少重复**: 避免各服务重复实现通用功能
- **版本控制**: 统一管理依赖版本，避免版本不一致问题

#### 开发效率提升
- **专注业务**: 开发人员可以专注于业务逻辑，而不是基础设施
- **快速上手**: 新团队成员可以快速理解和使用标准组件
- **质量保证**: 共享组件经过全面测试和优化

#### 潜在挑战与对策
- **依赖耦合**: 所有服务依赖同一个common模块，版本升级需要协调
  - 对策: 严格的向后兼容性保证、语义化版本控制
- **抽象开销**: 额外的抽象层可能引入少量性能开销
  - 对策: 关键路径优化、提供直接访问原生客户端的方法
- **特殊需求**: 特定服务的特殊需求可能难以在通用模块中满足
  - 对策: 提供扩展点和插件机制，允许定制行为

---

## 文档版本信息

- **版本**: 5.0.0
- **最后更新**: 2024年
- **维护团队**: IM架构组
- **架构模式**: 分布式单体架构（核心服务+业务服务合并优化）
- **通信方式**: 服务内部直接调用 + NATS消息总线 + 共享库
- **审核状态**: 已审核 