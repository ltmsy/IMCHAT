 # IM 系统业务服务文档

## 文档概述

本文档详细描述 im-business-service 业务单体服务的设计与实现，包括：
- 权限模块：群成员/角色、禁言/黑名单、加入/退出事件、会话权限核验
- 媒体模块：媒体直传签发、上传鉴权与配额、转码/缩略图、内容安全
- 定时任务模块：定时任务调度、数据清理、统计报表、数据同步

---

## 2.1 业务服务模块

### im-business-service（业务单体服务）
- **主要职责**: 
  - **权限模块**: 群成员/角色、禁言/黑名单、加入/退出事件、会话权限核验、权限缓存管理
  - **媒体模块**: 媒体直传签发、上传鉴权与配额、转码/缩略图、内容安全、存储管理
  - **定时任务模块**: 定时任务调度、数据清理、统计报表、数据同步、监控告警
- **核心特性**: 
  - 内部模块间直接方法调用，零网络延迟
  - 共享缓存和配置，提高资源利用率
  - 支持水平扩展，每个节点独立处理业务请求
- **业务管理**: 统一的权限控制、媒体处理、定时任务调度

### 权限模块详细结构
```
auth/
├── service/                     # 权限服务
│   ├── AuthService.java         # 权限服务接口
│   ├── GroupAuthService.java    # 群组权限服务
│   └── UserAuthService.java     # 用户权限服务
├── model/                       # 权限模型
│   ├── Permission.java          # 权限定义
│   ├── Role.java                # 角色定义
│   └── AuthResult.java          # 权限结果
├── member/                      # 成员管理
│   ├── MemberManager.java       # 成员管理器
│   ├── GroupMember.java         # 群组成员
│   └── MembershipStore.java     # 成员关系存储
├── rule/                        # 规则管理
│   ├── RuleManager.java         # 规则管理器
│   ├── MuteRule.java            # 禁言规则
│   └── BlacklistRule.java       # 黑名单规则
├── cache/                       # 缓存管理
│   ├── AuthCache.java           # 权限缓存
│   ├── RoleCache.java           # 角色缓存
│   └── CacheInvalidator.java    # 缓存失效
└── event/                       # 事件处理
    ├── MemberEventHandler.java  # 成员事件处理
    ├── JoinEvent.java           # 加入事件
    └── LeaveEvent.java          # 离开事件
```

### 媒体模块详细结构
```
media/
├── upload/                      # 上传管理
│   ├── UploadService.java       # 上传服务
│   ├── UploadToken.java         # 上传凭证
│   └── QuotaManager.java        # 配额管理
├── storage/                     # 存储管理
│   ├── StorageService.java      # 存储服务
│   ├── MinioStorage.java        # MinIO存储
│   └── StoragePolicy.java       # 存储策略
├── process/                     # 处理管理
│   ├── MediaProcessor.java      # 媒体处理器
│   ├── ImageProcessor.java      # 图片处理
│   └── VideoProcessor.java      # 视频处理
├── security/                    # 安全管理
│   ├── ContentScanner.java      # 内容扫描
│   ├── SensitiveDetector.java   # 敏感检测
│   └── WatermarkManager.java    # 水印管理
├── thumbnail/                   # 缩略图管理
│   ├── ThumbnailGenerator.java  # 缩略图生成
│   ├── ImageResizer.java        # 图片缩放
│   └── ThumbnailStore.java      # 缩略图存储
└── lifecycle/                   # 生命周期管理
    ├── LifecycleManager.java    # 生命周期管理器
    ├── ExpirationPolicy.java    # 过期策略
    └── CleanupTask.java         # 清理任务
```

### 定时任务模块详细结构
```
scheduler/
├── xxljob/                      # XXL-Job集成
│   ├── XxlJobConfig.java        # XXL-Job配置
│   ├── JobHandlerRegistry.java  # 任务处理器注册
│   └── ExecutorConfig.java      # 执行器配置
├── handler/                     # 任务处理器
│   ├── DataCleanJobHandler.java # 数据清理任务
│   ├── StatisticsJobHandler.java # 统计任务
│   └── SyncJobHandler.java      # 同步任务
├── service/                     # 任务服务
│   ├── TaskService.java         # 任务服务接口
│   ├── CleanupService.java      # 清理服务
│   └── ReportService.java       # 报表服务
├── monitor/                     # 监控管理
│   ├── JobMonitor.java          # 任务监控
│   ├── ExecutionLogger.java     # 执行日志
│   └── AlertNotifier.java       # 告警通知
└── utils/                       # 工具类
    ├── CronUtils.java           # Cron表达式工具
    ├── JobParamUtils.java       # 任务参数工具
    └── FailoverUtils.java       # 故障转移工具
```

---

## 6. 媒体消息处理策略

### 6.1 推荐处理模式

#### HTTP直传+WebSocket引用
**步骤流程**:
1. 获取上传凭证：`POST /media/sts`或`/media/upload`
2. 文件上传至对象存储
3. 回调/轮询获取转码/缩略图结果
4. 通过WS发送SendMessageReq，body为MediaRef

### 6.2 鉴权与配额管理

#### 上传前校验
- Token验证与配额检查
- 按用户级别限制大小与日额度
- URL短期有效（STS临时URL或签名URL）

#### 内容安全
- 异步扫描：文本敏感词、图像/音视频涉敏模型
- 违规处理：标记消息状态或撤回
- 客户端适配：状态变更为违规时可变灰或不可见

### 6.3 优化策略

#### 断点续传
- 大文件分片上传
- WebSocket仅传引用，避免占用接入链路

#### 小体积优化
- 表情/短语音可直接走WS二进制帧
- 推荐走直传以复用CDN、审计与续传

---

## 9.5 数据库职责分配

#### MySQL（业务数据）
- **维护方**: im-business-service（权限模块）
- **主要存储**:
  - 用户信息
  - 群组信息
  - 成员关系
  - 权限配置
- **访问方式**:
  - im-core-service通过NATS请求im-business-service进行权限校验
  - im-core-service不直接连接MySQL

#### Redis（缓存数据）
- **维护方**: 各服务独立维护自己的缓存空间
  - im-business-service: 权限缓存、媒体处理状态
- **命名空间隔离**:
  - 使用前缀区分不同服务的缓存: `business:`
- **共享实例**: 所有服务共享Redis集群，但使用不同的命名空间

---

## 18.2 业务服务配置

#### 基础参数
- 权限模块：权限缓存TTL 300s，权限校验超时5s
- 媒体模块：上传文件大小限制100MB，转码超时300s
- XXL-Job模块：执行器端口9999，注册方式自动注册，任务线程池大小20

#### 内部模块配置
- 权限模块：权限缓存大小1000条，权限校验QPS 10000
- 媒体模块：并发上传数100，转码并发数50
- XXL-Job模块：日志保留天数30，失败重试次数3，任务超时时间600s

---

## 23. 默认策略与SLO矩阵

### 23.1 权限校验默认策略矩阵

| 会话类型 | 消息类型 | 通道状态:正常 | 通道状态:降级 | 通道状态:超时 | 审计级别 |
|---------|---------|-------------|-------------|-------------|---------|
| 单聊(P2P) | 文本消息 | 校验通过放行 | 本地缓存+放行 | 放行+异步审计 | 低 |
| 单聊(P2P) | 媒体消息 | 校验通过放行 | 本地缓存+放行 | 放行+异步审计 | 中 |
| 单聊(P2P) | 控制消息 | 校验通过放行 | 本地缓存+放行 | 拒绝 | 低 |
| 群聊(普通) | 文本消息 | 校验通过放行 | 本地缓存+放行 | 放行+异步审计 | 中 |
| 群聊(普通) | 媒体消息 | 校验通过放行 | 本地缓存+放行 | 拒绝 | 高 |
| 群聊(普通) | 控制消息 | 校验通过放行 | 本地缓存+放行 | 拒绝 | 中 |
| 群聊(敏感) | 文本消息 | 校验通过放行 | 严格校验+放行 | 拒绝 | 高 |
| 群聊(敏感) | 媒体消息 | 校验通过放行 | 严格校验+放行 | 拒绝 | 高 |
| 群聊(敏感) | 控制消息 | 校验通过放行 | 严格校验+放行 | 拒绝 | 高 |
| 系统通知 | 所有类型 | 校验通过放行 | 严格校验+放行 | 放行+全量审计 | 高 |

**说明**：
- **通道状态:正常**：权限服务响应时间<100ms，正常校验
- **通道状态:降级**：权限服务响应时间100-300ms或错误率1-5%，采用本地缓存辅助决策
- **通道状态:超时**：权限服务响应时间>300ms或错误率>5%，采用默认策略
- **敏感群组**：由管理员标记的需要特殊控制的群组，如大型公开群、官方群等
- **审计级别**：决定异步审计的优先级和详细程度

### 23.2 ACK与消息状态机

#### 消息状态定义
- **SENDING**：客户端已发送，服务端未确认
- **ACCEPTED**：服务端已接收，已入队待处理
- **STORED**：已分配序号并确认存储
- **DELIVERED**：已投递给接收方
- **READ**：接收方已读取
- **REVOKED**：消息已撤回或被系统删除
- **FAILED**：发送失败

#### 状态转换与失败处理
```
┌─────────┐                              ┌─────────────┐
│ 客户端   │                              │ 服务端       │
└────┬────┘                              └──────┬──────┘
     │                                          │
     │  发送消息(SENDING)                        │
     │─────────────────────────────────────────>│
     │                                          │ 接收消息
     │                                          │ 快速校验通过
     │                                          │ 消息入队
     │  ACK(clientMsgId, status=ACCEPTED)       │
     │<─────────────────────────────────────────│
     │                                          │
     │  更新UI状态(ACCEPTED)                     │ 分配序号
     │  (显示为"发送中")                         │ 存储消息
     │                                          │
     │  ACK(serverMsgId, seq, status=STORED)    │
     │<─────────────────────────────────────────│
     │                                          │
     │  更新UI状态(STORED)                       │
     │  (显示为"已发送")                         │
     │                                          │ 开始扇出
     │                                          │
     │  消息投递通知(可选)                        │
     │<─────────────────────────────────────────│
     │                                          │
     │  更新UI状态(DELIVERED)                    │
     │  (显示为"已送达")                         │
```

#### 存储失败处理机制

##### 存储失败状态回滚
1. **存储失败检测**：
   - 数据库写入失败
   - 序号分配失败
   - 缓存更新失败
2. **失败回滚流程**：
   - 向客户端推送 `ACK(status=FAILED, errorCode, errorMsg)`
   - 客户端收到失败ACK后，将消息状态回滚至SENDING
   - 客户端显示"发送失败"状态，提供重试按钮
3. **自动重试策略**：
   - 服务端自动重试3次，间隔递增(1s, 3s, 5s)
   - 重试成功后推送 `ACK(status=STORED)`
   - 重试失败后推送 `ACK(status=FAILED)`

##### 客户端自我修复流程
1. **断网重连检测**：
   - 检测到网络恢复后，主动查询所有SENDING状态消息
   - 向服务端发送 `QueryMessageStatus(clientMsgId)` 请求
2. **状态同步**：
   - 服务端返回消息实际状态
   - 客户端根据返回状态更新本地UI
   - 对于ACCEPTED状态消息，等待STORED确认
3. **失败消息处理**：
   - 对于FAILED状态消息，显示重试选项
   - 对于REVOKED状态消息，显示撤回通知
   - 对于DELIVERED状态消息，更新为已送达状态

#### 消息状态一致性保障
1. **幂等性保证**：
   - 使用clientMsgId作为幂等键
   - 重复的clientMsgId直接返回已存在的状态
2. **状态同步机制**：
   - 客户端定期同步消息状态
   - 服务端主动推送状态变更通知
3. **异常恢复策略**：
   - 服务端重启后，从数据库恢复消息状态
   - 客户端重启后，从服务端同步消息状态
   - 网络异常后，自动重连并同步状态

---

## 24.5 RTC模块资源与QoS管理

#### 并发会议限制
- **系统级限制**：
  - 最大并发会议数：5000
  - 单会议最大参与者：50
  - 单用户最大并发会议：3

- **资源控制**：
  - Token生成QPS上限：5000/秒
  - 房间创建QPS上限：500/秒
  - 信令处理QPS上限：10000/秒

#### Token生成性能优化
- **生成策略**：
  - 批量预生成：高峰期前预生成Token池
  - 缓存复用：相同参数的Token短时间内复用
  - 异步生成：非阻塞Token生成

- **性能指标**：
  - 单Token生成时间：<5ms
  - 批量生成(100个)：<200ms
  - 内存占用：每1000个缓存Token约2MB

#### 回调处理与幂等性
- **回调接收设计**：
  - 接收限流：每节点1000 QPS
  - 处理超时：2秒
  - 队列缓冲：最大10000条

- **幂等处理**：
  - 幂等键：`{eventType}:{resourceId}:{timestamp}`
  - 幂等窗口：5分钟
  - 重复事件处理：忽略或更新最新状态

#### 防刷策略
- **限制规则**：
  - 单用户创建会议：10次/小时
  - 单IP创建会议：50次/小时
  - 加入会议尝试：20次/分钟

- **异常检测**：
  - 短时间内多次加入/退出：标记可疑
  - 频繁切换设备：要求额外验证
  - 跨地域快速登录：触发安全检查

#### 网络分区与弱网策略
- **网络质量分级**：
  - 优良：RTT<100ms，丢包<1%
  - 良好：RTT<200ms，丢包<3%
  - 一般：RTT<500ms，丢包<5%
  - 较差：RTT<1000ms，丢包<10%
  - 极差：RTT>1000ms或丢包>10%

- **自动降级策略**：
  - 网络较差时：降低视频分辨率，优先保证音频
  - 网络极差时：仅保留音频，关闭视频
  - 完全断连：保持会议状态5分钟，等待重连

- **弱网优化**：
  - 丢包补偿：FEC前向纠错
  - 自适应码率：根据网络状况动态调整
  - 优先级控制：音频>共享屏幕>视频
  - 重连策略：指数退避，最长保持会话10分钟

---

## 文档版本信息

- **版本**: 5.0.0
- **最后更新**: 2024年
- **维护团队**: IM架构组
- **架构模式**: 分布式单体架构（核心服务+业务服务合并优化）
- **通信方式**: 服务内部直接调用 + NATS消息总线 + 共享库
- **审核状态**: 已审核