# IM 系统运维部署文档

## 文档概述

本文档详细描述 IM 系统的运维部署相关内容，包括：
- 高可用与容灾设计：故障转移、数据备份、容灾策略
- 观测与运维体系：监控指标、日志规范、链路追踪、告警规则
- 压测与容量规划：压测场景、性能目标、容量规划
- 配置与运行参数：各服务配置参数、性能调优
- 错误码与安全：错误码规范、限流策略、安全机制

---

## 10. 错误码、限流与安全

### 10.1 错误码规范

#### 标准错误码
```
1001 AUTH_FAILED        # Token无效或过期
1003 FORBIDDEN          # 无权限/被禁言/被拉黑
1005 RATE_LIMITED       # 频控触发
1007 PAYLOAD_INVALID    # 字段或大小非法
1010 MEDIA_REQUIRED     # 媒体未上传或引用无效
1012 IDEMPOTENT_CONFLICT # 幂等冲突
1099 SERVER_BUSY        # 背压
1999 INTERNAL_ERROR     # 内部错误
```

### 10.2 限流策略

#### 限流维度
- 用户级、会话级、IP/设备级、类型级
- 管理侧在线变更限流规则
- 滑动窗口+令牌桶算法

### 10.3 安全机制

#### 基础安全
- Token签名与短期有效
- 重要操作二次校验
- 内容安全与审计日志

#### 防重放攻击
- clientMsgId+时间窗校验
- 时间戳与签名验证

---

## 11. 观测与运维体系

### 11.1 监控指标

#### 核心服务指标
- `connections`: 连接数
- `heartbeat_drop_rate`: 心跳丢失率
- `inbound/outbound_qps`: 入站/出站QPS
- `p99_write_latency`: P99写入延迟
- `backpressure_events`: 背压事件数
- `internal_call_latency`: 内部模块调用延迟
- `memory_usage`: 内存使用率

#### 业务服务指标
- `auth_check_qps`: 权限校验QPS
- `media_upload_qps`: 媒体上传QPS
- `xxl_job_success_rate`: XXL-Job任务成功率
- `xxl_job_execution_time`: XXL-Job任务执行时间
- `internal_call_latency`: 内部模块调用延迟
- `memory_usage`: 内存使用率

#### 消息分发指标
- `assign_seq_latency`: 序号分配延迟
- `batch_write_size`: 批量写入大小
- `retry_count`: 重试次数
- `fanout_qps`: 扇出QPS
- `p99_history_fetch`: P99历史查询延迟

#### 在线状态指标
- `route_lookup_qps`: 路由查询QPS
- `hotspot_key_rate`: 热键率
- `failover_time`: 故障转移时间

### 11.2 日志规范

#### 关键事件日志
- 鉴权失败原因
- 拒绝原因采样
- 异常回执
- 写失败与重试
- 上传失败

#### 隐私控制
- 敏感字段脱敏
- 遵循合规要求

### 11.3 链路追踪

#### Trace设计
- traceId注入Envelope.header
- 贯穿网关→消息→在线状态→存储→扇出
- 推送事件：deliverTs、ackTs、storeLatencyMs、fanoutCount

### 11.4 告警规则

#### 告警维度
- SLA违反（ACK延迟、丢消息率）
- 队列积压
- 热键告警
- 连接抖动
- 媒资异常

---

## 12. 数据保留与合规

### 12.1 数据保留策略

#### 分层存储
- **热数据**: 近7~30天
- **冷数据**: 归档存储，查询走异步任务或延迟响应

### 12.2 合规要求

#### 数据删除
- 用户删除请求的数据处理
- 软删标记+定期物理清理

#### 审计导出
- 按会话/时间窗口导出可验证日志
- 数据加密与访问控制

### 12.3 备份与恢复

#### 备份策略
- 周期性快照
- 跨可用区/区域复制
- 演练恢复流程

---

## 13. 客户端交互约定

### 13.1 连接与重连

#### 连接策略
- 首次连接带token与设备信息
- 断线重连携带上次per-conversation lastSeq

### 13.2 消息提交

#### 提交流程
- 先媒体上传（如需要），再提交WS SendMessageReq
- 期待在超时内收到ACK
- 收到ACK后更新本地映射clientMsgId→serverMsgId, seq

### 13.3 拉取策略

#### 历史拉取
- 打开会话先拉取最近N条
- 有缺口则按seq拉取
- 大群默认只拉摘要或分页加载

#### 回执处理
- 阅读时发送read-receipt
- 包含conversationId, readSeq
- 服务端更新未读计数

---

## 14. 升级与兼容策略

### 14.1 契约变更流程

#### 升级顺序
- 先升级消费者（忽略未知字段）
- 再升级生产者（开始发送新字段）
- 枚举新值灰度：先静默发送到小流量

### 14.2 网关灰度

#### 灰度策略
- 按客户端版本标签路由
- 出现不兼容快速回滚

### 14.3 数据迁移

#### 迁移原则
- 表结构只增不删
- 删除字段走shadow字段与双写过渡

---

## 15. 压测与容量规划

### 15.1 压测场景

#### 连接压测
- 长连接保活：10万/节点
- 心跳30s，掉线率<0.5%

#### 消息压测
- 发送峰值：单会话5k msg/s顺序保障
- 全站扇出：100万msg/s

#### 查询压测
- 历史拉取：P99<100ms（缓存命中）
- 冷查询：<800ms

### 15.2 压测工具

#### 工具选择
- 自研WS压测器（多连接/多会话混合流）
- 人工注入热点会话、热键、网卡/CPU限流测试

### 15.3 性能优化抓手

#### 关键优化点
- 批量写、零拷贝、协议压缩
- 热点分片、只读缓存、异步扇出

---

## 18. 配置与运行参数

### 18.1 核心服务配置

#### 基础参数
- 心跳超时：90s
- 最大消息体：文本32KB，二进制256KB
- 写合并窗口：2~5ms
- 每连接发送队列：上限100条或1MB

#### 内部模块配置
- 网关模块：最大连接数2.5万，心跳间隔30s
- 消息模块：批量写入大小200条，分片数32
- 在线状态模块：缓存TTL 120s，故障检测间隔5s

### 18.2 业务服务配置

#### 基础参数
- 权限模块：权限缓存TTL 300s，权限校验超时5s
- 媒体模块：上传文件大小限制100MB，转码超时300s
- XXL-Job模块：执行器端口9999，注册方式自动注册，任务线程池大小20

#### 内部模块配置
- 权限模块：权限缓存大小1000条，权限校验QPS 10000
- 媒体模块：并发上传数100，转码并发数50
- XXL-Job模块：日志保留天数30，失败重试次数3，任务超时时间600s

### 18.3 消息分发配置

#### 性能参数
- 分片数：按核心数×2起步
- 批量写：50~200条/次或5~20ms
- 幂等窗口：7天
- 冷热分界：30天

### 18.4 在线状态配置

#### 缓存参数
- TTL：路由120s，在线状态滑动窗口2×心跳周期
- 会话与成员事实：TTL 60~120s，变更主动失效

### 18.5 限流配置

#### 限流规则
- 文本：用户级30 msg/min
- 媒体：10 item/min
- 大群会话级：500 msg/s

---

## 19. 典型时序流程

### 19.1 发送消息流程

#### 详细步骤
1. 客户端→核心服务网关模块：SendMessageReq（或先媒资上传）
2. 网关模块：快速校验通过→内部调用消息模块；否则NACK
3. 消息模块：通过NATS调用业务服务权限校验→分配seq→落库→内部调用在线状态模块查询在线成员
4. 网关模块：向发送方回Ack；向接收方推送消息

### 19.2 断线重连流程

#### 重连策略
1. 客户端：带上lastSeq清单
2. 网关模块：鉴权通过→查询缺口→指示增量拉取或服务端主动补发

---

## 20. 代码与生成规范

### 20.1 Protobuf规范

#### 代码生成
- 统一生成脚本
- CI校验生成物与proto一致性
- 禁止手改生成代码
- 只在shared-libs提交

### 20.2 依赖管理

#### 版本控制
- shared-libs发布版本号
- 服务按版本依赖
- 禁止跨模块源码引用

### 20.3 质量门槛

#### 测试要求
- 单元测试覆盖率门槛
- 端到端测试覆盖发送/拉取/断线/权限/媒体路径

### 20.4 安全扫描

#### 安全检查
- 依赖漏洞扫描
- 敏感信息泄露检查
- 证书与密钥轮换策略

---

## 21. 风险与对策清单

### 21.1 技术风险

#### 大群热点风险
- **风险**: Redis热键导致性能下降
- **对策**: 随机过期、局部缓存、分层计数、限制即时未读精度

#### 扇出放大风险
- **风险**: 队列积压影响系统性能
- **对策**: 批量处理、优先级队列、消息降采样（提示+拉取）

#### 幂等表膨胀
- **风险**: 幂等表数据量过大
- **对策**: TTL清理、冷热分层、按天分表

### 21.2 业务风险

#### 升级兼容风险
- **风险**: 协议升级导致不兼容
- **对策**: 先消费后生产、灰度流量小范围验证、回滚预案

#### 媒体滥用风险
- **风险**: 媒体直传被恶意利用
- **对策**: STS最小权限与短时效、大小与频率限流、审计告警

---

## 22. 最小可行实现（MVP）

### 22.1 核心功能

#### 基础消息
- 支持文本、图片引用消息
- 单聊和小型群聊

#### 连接管理
- WS连接、心跳、ACK
- 历史拉取与未读游标

#### 权限控制
- 基础权限（成员关系、禁言）
- 媒体直传与内容安全占位

### 22.2 观测能力

#### 监控指标
- 基础指标+采样日志+Trace
- 压测脚本与回归用例

---

## 24.3 Presence路由一致性与跨节点广播

#### 路由一致性目标
- **收敛时间目标**：
  - 单区域：<500ms
  - 跨区域：<2000ms

- **一致性级别**：
  - 默认：最终一致性
  - 关键操作：读写一致性（通过锁或版本控制）

- **校验机制**：
  - 定期校验任务：每10分钟运行一次
  - 不一致修复：自动同步Redis与本地缓存

#### 跨节点广播优化
- **广播查询优化**：
  ```java
  // 优化前
  function broadcastQuery(userId) {
    // 向所有节点广播查询
    return natsClient.request("im.presence.query", userId);
  }
  
  // 优化后
  function broadcastQuery(userId) {
    // 1. 计算可能的节点范围(一致性哈希)
    List<String> possibleNodes = consistentHash.getPossibleNodes(userId);
    
    // 2. 并行查询可能节点，限制范围
    CompletableFuture<?>[] futures = possibleNodes.stream()
      .map(node -> natsClient.request("im.presence.query." + node, userId))
      .toArray(CompletableFuture<?>[]::new);
    
    // 3. 等待第一个成功响应或全部失败
    return CompletableFuture.anyOf(futures)
      .orTimeout(200, TimeUnit.MILLISECONDS);
  }
  ```

- **广播效率提升**：
  - 一致性哈希限制查询范围
  - 并行查询与首个响应优先
  - 超时控制避免长尾延迟

#### 连接迁移与优雅摘流
- **节点下线步骤**：
  1. 标记节点为"准备下线"状态
  2. 停止接受新连接
  3. 通知负载均衡器停止转发流量
  4. 向现有连接发送CODE_RECONNECT指令
  5. 等待连接数降至阈值(如总数的10%)或超时(2分钟)
  6. 强制关闭剩余连接
  7. 完全下线节点

- **优雅摘流流程**：
  ```
  ┌─────────────┐          ┌─────────────┐          ┌─────────────┐
  │ 负载均衡器   │          │ 待下线节点   │          │ 活跃节点     │
  └──────┬──────┘          └──────┬──────┘          └──────┬──────┘
         │                        │                        │
         │                        │ 1. 发送准备下线信号      │
         │                        │───────────────────────>│
         │                        │                        │
         │ 2. 更新节点权重(0)      │                        │
         │<───────────────────────│                        │
         │                        │                        │
         │ 3. 停止新连接转发       │                        │
         │─────────────────────────────────────────────────>│
         │                        │                        │
         │                        │ 4. 向客户端发送重连指令   │
         │                        │───────────────────────>│
         │                        │                        │
         │                        │ 5. 等待连接迁移         │
         │                        │<──────────────────────>│
         │                        │                        │
         │                        │ 6. 通知迁移完成         │
         │                        │───────────────────────>│
         │                        │                        │
         │ 7. 节点完全下线         │                        │
         │<───────────────────────│                        │
         │                        │                        │
  ```

- **滚动升级策略**：
  - 按区域依次升级，每次不超过1/3的节点
  - 每个节点升级后验证健康状态
  - 升级间隔：至少5分钟，确保系统稳定
  - 回滚触发条件：错误率上升>0.5%或延迟上升>50%

#### 路由数据校验任务
- **校验周期**：每10分钟执行一次
- **校验范围**：随机抽样1%的活跃用户
- **校验流程**：
  1. 对比Redis路由数据与各节点本地缓存
  2. 检测孤立路由（用户已下线但路由仍存在）
  3. 检测缺失路由（用户在线但路由不存在）
  4. 自动修复不一致数据
- **校验指标**：
  - `route_inconsistency_rate`: 路由不一致率
  - `route_repair_count`: 修复次数
  - `orphaned_route_count`: 孤立路由数

### 24.4 安全与合规边界细化

#### 数据域合规责任分界
- **消息内容**：
  - 存储位置：MongoDB
  - 保留期限：普通消息30天热存储+150天冷存储
  - 责任主体：平台方负责存储安全，内容合规由用户负责
  - 审计能力：支持按会话ID、用户ID、时间范围、关键词检索

- **媒体文件**：
  - 存储位置：MinIO/对象存储
  - 保留期限：默认90天，重要媒体365天
  - 责任主体：平台方负责存储和基础内容安全扫描
  - 审计能力：支持按上传者、文件类型、大小、时间检索

- **音视频记录**：
  - 存储位置：声网云存储
  - 保留期限：默认30天，标记重要可延长至90天
  - 责任主体：平台方与声网共同负责，需明确告知用户录制行为
  - 法务要求：录制前必须获得用户明确同意，界面显示录制状态

#### 数据安全保障措施
- **数据加密**：
  - 传输加密：TLS 1.3
  - 存储加密：AES-256-GCM
  - 密钥管理：使用KMS，自动轮换

- **密钥轮换周期**：
  - 传输密钥：30天
  - 存储密钥：90天
  - 签名密钥：180天

- **跨境传输控制**：
  - 数据本地化：用户数据存储在用户所属区域
  - 区域隔离：不同区域的数据不互通
  - 跨境审批：需要特殊授权才能进行跨境数据访问

#### 客户端鉴权与会话安全
- **Token设计**：
  ```
  {
    "alg": "HS256",
    "typ": "JWT"
  }
  {
    "sub": "userId",
    "deviceId": "deviceUniqueId",
    "iat": 1516239022,
    "exp": 1516242622,
    "scopes": ["message:send", "presence:update"],
    "nonce": "randomString",
    "ver": "1.0"
  }
  ```

- **Token策略**：
  - 有效期：1小时
  - 自动续期：剩余时间<15分钟时刷新
  - 最大续期：7天，之后需重新登录
  - 设备绑定：Token与设备ID绑定

- **Token撤销机制**：
  - 主动撤销：用户登出或管理员操作
  - 被动撤销：密码变更、异常登录
  - 撤销传播：通过Redis发布订阅+NATS广播

- **设备黑名单**：
  - 存储位置：Redis集合
  - 判定条件：短时间内多次认证失败、异常行为检测
  - 解除策略：24小时后自动解除或管理员手动解除
  - 黑名单同步：实时同步到所有网关节点

#### 审计与合规查询
- **审计日志**：
  - 关键操作：登录、发送敏感消息、权限变更、管理操作
  - 日志字段：操作类型、用户ID、IP、设备信息、时间戳、操作结果
  - 存储位置：专用审计日志库，独立访问控制

- **合规检索能力**：
  - 最大检索时间范围：180天
  - 检索响应时间：
    - 热数据(30天内)：<10秒
    - 冷数据(30-180天)：<5分钟
  - 导出格式：CSV、JSON、PDF(带数字签名)

- **访问控制**：
  - 基于角色：审计员、合规官、管理员
  - 操作记录：所有检索操作留痕
  - 敏感导出：需二次授权和双人审批

### 25.5 缓存治理与热点防护

#### 热门群缓存策略
1. **群成员列表分块存储**：
   - 大群(>500人)：按500人一块分片存储
   - 超大群(>5000人)：按1000人一块分片存储
   - 分块键格式：`group:{groupId}:members:{chunkId}`
   - 分块策略：`chunkId = memberIndex / chunkSize`

2. **超大群推送优化**：
   - 实时推送：仅推送"有新消息"通知
   - 详细拉取：用户点击进入时再拉取消息内容
   - 缓存策略：消息内容按需缓存，避免内存浪费

##### 缓存雪崩防护
1. **随机过期时间策略**：
   - 基础TTL：300秒
   - 随机偏移：±30秒，避免同时过期
   - 实现方式：`TTL = baseTTL + random(-30, 30)`

2. **热点键分散策略**：
   - 热门群：按群ID哈希分散到不同Redis节点
   - 用户会话：按userId哈希分散
   - 消息缓存：按conversationId哈希分散

##### 缓存容量控制
1. **内存限制策略**：
   - Redis最大内存：物理内存的80%
   - 淘汰策略：LRU + TTL混合
   - 监控告警：内存使用率>85%时告警

2. **热点数据治理**：
   - 自动识别：监控访问频率，识别热点键
   - 主动分散：将热点键分散到多个节点
   - 降级策略：热点键过多时，降低缓存命中率要求

#### 缓存性能优化
1. **批量操作优化**：
   - 群成员查询：使用Redis Pipeline批量获取
   - 消息缓存：批量写入，减少网络往返
   - 会话状态：批量更新，提高吞吐量

2. **本地缓存策略**：
   - 热点数据：在应用层维护本地缓存
   - 缓存同步：通过NATS事件同步本地缓存
   - 过期策略：本地缓存TTL < Redis TTL，避免数据不一致

### 25.6 重试风暴防护与熔断策略

#### 重试规则统一策略
1. **只允许一边重试原则**：
   - 前端重试：仅对网络错误进行重试，业务错误不重试
   - 后端重试：仅对系统内部错误进行重试，用户错误不重试
   - 避免双方同时重试，防止重试风暴

2. **重试策略配置**：
   - 权限校验：不重试，超时直接降级
   - 消息发送：前端不重试，后端自动重试3次
   - 媒体上传：前端重试3次，后端不重试
   - 配置查询：前端不重试，后端重试2次

#### 退避策略与限流
1. **指数退避策略**：
   - 第一次重试：延迟1秒
   - 第二次重试：延迟2秒
   - 第三次重试：延迟4秒
   - 最大重试间隔：30秒

2. **限流策略**：
   - 单用户重试频率：每分钟最多10次
   - 单服务重试频率：每分钟最多1000次
   - 全局重试频率：每分钟最多10000次

#### 熔断机制
1. **熔断触发条件**：
   - 错误率>50%持续1分钟：触发熔断
   - 响应时间>5秒持续2分钟：触发熔断
   - 连续失败>10次：触发熔断

2. **熔断状态管理**：
   - 关闭状态：正常处理请求
   - 开启状态：快速失败，不处理请求
   - 半开状态：允许少量请求尝试，成功后关闭熔断

3. **熔断恢复策略**：
   - 熔断开启后等待60秒进入半开状态
   - 半开状态下成功率>80%持续30秒，关闭熔断
   - 半开状态下失败率>50%，重新开启熔断

#### 监控与告警
1. **重试监控指标**：
   - 重试次数：按服务、接口、用户分类统计
   - 重试成功率：重试后成功的比例
   - 重试延迟：重试请求的响应时间

2. **告警阈值**：
   - 重试率>20%持续5分钟：触发告警
   - 熔断开启：立即告警
   - 重试风暴：重试次数突增>100%时告警

---

## 附录

### 附录A：错误码对照表
| 错误码 | 错误名称 | 说明 |
|--------|----------|------|
| 1001 | AUTH_FAILED | Token无效或过期 |
| 1003 | FORBIDDEN | 无权限/被禁言/被拉黑 |
| 1005 | RATE_LIMITED | 频控触发 |
| 1007 | PAYLOAD_INVALID | 字段或大小非法 |
| 1010 | MEDIA_REQUIRED | 媒体未上传或引用无效 |
| 1012 | IDEMPOTENT_CONFLICT | 幂等冲突 |
| 1099 | SERVER_BUSY | 背压 |
| 1999 | INTERNAL_ERROR | 内部错误 |

### 附录B：观测字段建议
- **Envelope.header**: traceId、clientMsgId、deviceId、codecVersion、sendTs
- **推送事件**: deliverTs、ackTs、storeLatencyMs、fanoutCount

### 附录C：数据保密与合规建议
- PII脱敏、数据最小化、日志留存周期、访问审计、导出加密

---

## 文档版本信息

- **版本**: 5.0.0
- **最后更新**: 2024年
- **维护团队**: IM架构组
- **架构模式**: 分布式单体架构（核心服务+业务服务合并优化）
- **通信方式**: 服务内部直接调用 + NATS消息总线 + 共享库
- **审核状态**: 已审核

## 附录A：版本变更历史

| 版本   | 日期      | 主要变更                                          |
|-------|-----------|--------------------------------------------------|
| 5.0.0 | 2024年    | 增加高可用设计、一致性策略、热键防御、安全合规细节 |
| 4.4.0 | 2024年    | 增加声网集成方案、通话流程、录制与回放            |
| 4.3.0 | 2024年    | 增加默认策略与SLO矩阵、权限校验决策流程           |
| 4.2.0 | 2024年    | 完善数据库职责、NATS可靠性、幂等设计              |
| 4.1.0 | 2024年    | 增加共享库模块设计                                |
| 4.0.0 | 2024年    | 合并为三个主要服务：核心、业务、管理               |
| 3.0.0 | 2024年    | 合并网关、消息、在线状态为核心服务                 |
| 2.0.0 | 2024年    | 初始分布式单体架构，六个独立服务                   |
| 1.0.0 | 2024年    | 初始架构设计草案                                  | 